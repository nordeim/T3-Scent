# .env
```txt
# Environment variables for The Scent (local development)
# For production, set these in your hosting provider's dashboard.

# Prisma Database Connection
# User: scent_user
# Password: ScentAdmin%123 (URL encoded to ScentAdmin%25123)
# Database: the_scent
DATABASE_URL="postgresql://scent_user:ScentAdmin%25123@localhost:5432/the_scent?schema=public"

# NextAuth.js v5 Configuration
# Generate a strong secret: openssl rand -base64 32 or visit https://generate-secret.vercel.app/32
AUTH_SECRET="v0D7aEeTg7fWpG3Sb950xInjC7mbw1F7iNbc8n4RZYE=" # Generated by create-t3-app.
AUTH_URL="http://localhost:3000" # The base URL of your application for auth redirects
AUTH_TRUST_HOST="true" # For development with non-HTTPS localhost or dynamic Vercel URLs. Set to "false" or remove for production if using a fixed HTTPS URL.

# OAuth Providers (Example: Google)
# Ensure these are also configured in src/server/auth.ts if used.
GOOGLE_CLIENT_ID="" # Your Google Client ID
GOOGLE_CLIENT_SECRET="" # Your Google Client Secret

# Optional: Discord Provider (as in your original .env)
# AUTH_DISCORD_ID=""
# AUTH_DISCORD_SECRET=""
# Next Auth Discord Provider
AUTH_DISCORD_ID=""
AUTH_DISCORD_SECRET=""

# Stripe Configuration (Use TEST keys for development)
STRIPE_SECRET_KEY="sk_test_YOUR_STRIPE_TEST_SECRET_KEY"
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="pk_test_YOUR_STRIPE_TEST_PUBLISHABLE_KEY"
# STRIPE_WEBHOOK_SECRET="whsec_YOUR_STRIPE_LOCAL_WEBHOOK_SECRET" # For testing webhooks locally

# Application Configuration
NEXT_PUBLIC_SITE_URL="http://localhost:3000" # Public URL of your site

# Optional: Email Service (if using one like Resend, SendGrid)
# RESEND_API_KEY=""
# EMAIL_FROM="noreply@thescent.example.com"

# Note: The comment "# When adding additional environment variables, the schema in "/src/env.js" # should be updated accordingly."
# is good practice. Your env schema file is `src/env.mjs`.

```

# create_database_schema.sql
```sql
-- PostgreSQL DDL Script Generated from Prisma Schema
-- Version: 1.0 (The Scent E-commerce Platform)

-- Create Enums (PostgreSQL specific syntax)
CREATE TYPE "Role" AS ENUM ('ADMIN', 'MANAGER', 'CUSTOMER');
CREATE TYPE "OrderStatus" AS ENUM ('PENDING', 'AWAITING_PAYMENT', 'PROCESSING', 'PAID', 'ON_HOLD', 'SHIPPED', 'IN_TRANSIT', 'OUT_FOR_DELIVERY', 'DELIVERED', 'COMPLETED', 'CANCELLED', 'REFUND_PENDING', 'REFUNDED', 'FAILED');
CREATE TYPE "AddressType" AS ENUM ('SHIPPING', 'BILLING');
CREATE TYPE "ReviewStatus" AS ENUM ('PENDING', 'APPROVED', 'REJECTED');
CREATE TYPE "NotificationType" AS ENUM ('ORDER_CONFIRMATION', 'ORDER_PAYMENT_SUCCESS', 'ORDER_PAYMENT_FAILED', 'ORDER_STATUS_UPDATE', 'ORDER_SHIPPED', 'ORDER_OUT_FOR_DELIVERY', 'ORDER_DELIVERED', 'ORDER_CANCELLED', 'ORDER_REFUNDED', 'WELCOME_EMAIL', 'PASSWORD_RESET', 'EMAIL_VERIFICATION', 'PROFILE_UPDATE', 'LOW_STOCK_ALERT', 'BACK_IN_STOCK', 'NEW_PRODUCT_LAUNCHED', 'PRICE_DROP_ALERT', 'SUBSCRIPTION_CREATED', 'SUBSCRIPTION_REMINDER', 'SUBSCRIPTION_PAYMENT_SUCCESS', 'SUBSCRIPTION_PAYMENT_FAILED', 'SUBSCRIPTION_CANCELLED', 'SUBSCRIPTION_UPDATED', 'LOYALTY_POINTS_EARNED', 'LOYALTY_TIER_UPGRADE', 'LOYALTY_REWARD_REDEEMED', 'LOYALTY_POINTS_EXPIRING_SOON', 'SMART_HOME_DEVICE_CONNECTED', 'SMART_HOME_DEVICE_OFFLINE', 'SMART_HOME_AUTOMATION_TRIGGERED', 'SMART_HOME_SCENT_LOW', 'PROMOTIONAL_OFFER', 'NEWSLETTER_UPDATE', 'SURVEY_INVITATION', 'SYSTEM_ANNOUNCEMENT', 'ADMIN_ALERT');
CREATE TYPE "SubscriptionFrequency" AS ENUM ('WEEKLY', 'BIWEEKLY', 'MONTHLY', 'EVERY_TWO_MONTHS', 'QUARTERLY', 'EVERY_SIX_MONTHS', 'ANNUALLY');
CREATE TYPE "SubscriptionStatus" AS ENUM ('ACTIVE', 'PAUSED', 'CANCELLED', 'EXPIRED', 'PENDING_PAYMENT', 'ADMIN_SUSPENDED');
CREATE TYPE "LoyaltyPointLogType" AS ENUM ('EARN_PURCHASE', 'EARN_REVIEW_PRODUCT', 'EARN_SIGNUP_BONUS', 'EARN_REFERRAL_BONUS', 'EARN_COMPLETE_QUIZ', 'EARN_BIRTHDAY_BONUS', 'EARN_SOCIAL_SHARE', 'REDEEM_REWARD', 'ADJUST_ADMIN_CREDIT', 'ADJUST_ADMIN_DEBIT', 'EXPIRE_POINTS', 'REFUND_POINTS');
CREATE TYPE "RewardType" AS ENUM ('DISCOUNT_PERCENTAGE', 'DISCOUNT_FIXED_AMOUNT', 'FREE_SHIPPING', 'FREE_PRODUCT', 'VOUCHER_CODE', 'EXCLUSIVE_ACCESS', 'GIFT_CARD');
CREATE TYPE "UserRewardStatus" AS ENUM ('AVAILABLE', 'APPLIED', 'USED', 'EXPIRED');
CREATE TYPE "PurchaseOrderStatus" AS ENUM ('DRAFT', 'PENDING', 'CONFIRMED', 'SHIPPED', 'PARTIALLY_RECEIVED', 'RECEIVED', 'CANCELLED', 'CLOSED');
CREATE TYPE "SmartHomeDeviceType" AS ENUM ('AROMA_DIFFUSER', 'SMART_PLUG_DIFFUSER', 'AIR_PURIFIER_WITH_SCENT', 'SMART_LIGHT_SCENT_SYNC', 'OTHER_WELLNESS_DEVICE');
CREATE TYPE "AutomationTriggerType" AS ENUM ('TIME_OF_DAY', 'SUNRISE', 'SUNSET', 'USER_ENTERS_LOCATION', 'USER_LEAVES_LOCATION', 'DEVICE_STATE_CHANGE', 'SENSOR_READING', 'VOICE_COMMAND', 'APP_EVENT');
CREATE TYPE "QuizQuestionType" AS ENUM ('SINGLE_CHOICE_TEXT', 'MULTIPLE_CHOICE_TEXT', 'SINGLE_CHOICE_IMAGE', 'MULTIPLE_CHOICE_IMAGE', 'SCALE', 'TEXT_INPUT');

-- Create Tables

-- Table: users
CREATE TABLE "users" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "name" TEXT,
    "email" TEXT UNIQUE,
    "emailVerified" TIMESTAMP(3),
    "image" TEXT,
    "password" TEXT,
    "roleDefinitionId" TEXT,
    "role" "Role" NOT NULL DEFAULT 'CUSTOMER',
    "stripeCustomerId" TEXT UNIQUE,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL
);

-- Table: accounts
CREATE TABLE "accounts" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "userId" TEXT NOT NULL,
    "type" TEXT NOT NULL,
    "provider" TEXT NOT NULL,
    "providerAccountId" TEXT NOT NULL,
    "refresh_token" TEXT,
    "access_token" TEXT,
    "expires_at" INTEGER,
    "token_type" TEXT,
    "scope" TEXT,
    "id_token" TEXT,
    "session_state" TEXT,
    CONSTRAINT "accounts_userId_fkey" FOREIGN KEY ("userId") REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE CASCADE
);
CREATE UNIQUE INDEX "accounts_provider_providerAccountId_key" ON "accounts"("provider", "providerAccountId");

-- Table: sessions
CREATE TABLE "sessions" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "sessionToken" TEXT NOT NULL UNIQUE,
    "userId" TEXT NOT NULL,
    "expires" TIMESTAMP(3) NOT NULL,
    CONSTRAINT "sessions_userId_fkey" FOREIGN KEY ("userId") REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- Table: verification_tokens
CREATE TABLE "verification_tokens" (
    "identifier" TEXT NOT NULL,
    "token" TEXT NOT NULL UNIQUE,
    "expires" TIMESTAMP(3) NOT NULL
);
CREATE UNIQUE INDEX "verification_tokens_identifier_token_key" ON "verification_tokens"("identifier", "token");

-- Table: products
CREATE TABLE "products" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "name" TEXT NOT NULL,
    "slug" TEXT NOT NULL UNIQUE,
    "description" TEXT NOT NULL,
    "price" DECIMAL(10,2) NOT NULL,
    "compareAtPrice" DECIMAL(10,2),
    "costPrice" DECIMAL(10,2),
    "sku" TEXT UNIQUE,
    "barcode" TEXT,
    "weight" DOUBLE PRECISION,
    "dimensions" JSONB,
    "inStock" BOOLEAN NOT NULL DEFAULT true,
    "lowStockThreshold" INTEGER DEFAULT 5,
    "stockQuantity" INTEGER NOT NULL DEFAULT 0,
    "featured" BOOLEAN NOT NULL DEFAULT false,
    "bestSeller" BOOLEAN NOT NULL DEFAULT false,
    "isNew" BOOLEAN NOT NULL DEFAULT false,
    "onSale" BOOLEAN NOT NULL DEFAULT false,
    "saleEndDate" TIMESTAMP(3),
    "publishedAt" TIMESTAMP(3),
    "metaTitle" TEXT,
    "metaDescription" TEXT,
    "modelUrl" TEXT,
    "arPlacement" TEXT,
    "leadTime" INTEGER,
    "safetyStock" INTEGER,
    "turnoverRate" DOUBLE PRECISION,
    "forecastedDemand" INTEGER,
    "depletionDate" TIMESTAMP(3),
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL
);
CREATE INDEX "products_slug_idx" ON "products"("slug");
CREATE INDEX "products_featured_idx" ON "products"("featured");

-- Table: product_images
CREATE TABLE "product_images" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "productId" TEXT NOT NULL,
    "url" TEXT NOT NULL,
    "altText" TEXT,
    "width" INTEGER,
    "height" INTEGER,
    "position" INTEGER NOT NULL DEFAULT 0,
    CONSTRAINT "product_images_productId_fkey" FOREIGN KEY ("productId") REFERENCES "products"("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- Table: product_variants
CREATE TABLE "product_variants" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "productId" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "sku" TEXT UNIQUE,
    "price" DECIMAL(10,2),
    "stockQuantity" INTEGER NOT NULL DEFAULT 0,
    "options" JSONB NOT NULL,
    "imageUrl" TEXT,
    "isDefault" BOOLEAN NOT NULL DEFAULT false,
    CONSTRAINT "product_variants_productId_fkey" FOREIGN KEY ("productId") REFERENCES "products"("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- Table: categories
CREATE TABLE "categories" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "name" TEXT NOT NULL UNIQUE,
    "slug" TEXT NOT NULL UNIQUE,
    "description" TEXT,
    "imageUrl" TEXT,
    "parentId" TEXT,
    "position" INTEGER NOT NULL DEFAULT 0,
    CONSTRAINT "categories_parentId_fkey" FOREIGN KEY ("parentId") REFERENCES "categories"("id") ON DELETE SET NULL ON UPDATE CASCADE
);
CREATE INDEX "categories_slug_idx" ON "categories"("slug");

-- Table: tags
CREATE TABLE "tags" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "name" TEXT NOT NULL UNIQUE,
    "slug" TEXT NOT NULL UNIQUE
);
CREATE INDEX "tags_slug_idx" ON "tags"("slug");

-- Table: collections
CREATE TABLE "collections" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "name" TEXT NOT NULL UNIQUE,
    "slug" TEXT NOT NULL UNIQUE,
    "description" TEXT,
    "imageUrl" TEXT,
    "active" BOOLEAN NOT NULL DEFAULT true,
    "featured" BOOLEAN NOT NULL DEFAULT false,
    "startDate" TIMESTAMP(3),
    "endDate" TIMESTAMP(3)
);
CREATE INDEX "collections_slug_idx" ON "collections"("slug");

-- Relation Table: _ProductToCategory
CREATE TABLE "_ProductToCategory" (
    "A" TEXT NOT NULL,
    "B" TEXT NOT NULL,
    CONSTRAINT "_ProductToCategory_A_fkey" FOREIGN KEY ("A") REFERENCES "categories"("id") ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT "_ProductToCategory_B_fkey" FOREIGN KEY ("B") REFERENCES "products"("id") ON DELETE CASCADE ON UPDATE CASCADE
);
CREATE UNIQUE INDEX "_ProductToCategory_AB_unique" ON "_ProductToCategory"("A", "B");
CREATE INDEX "_ProductToCategory_B_index" ON "_ProductToCategory"("B");

-- Relation Table: _ProductToTag
CREATE TABLE "_ProductToTag" (
    "A" TEXT NOT NULL,
    "B" TEXT NOT NULL,
    CONSTRAINT "_ProductToTag_A_fkey" FOREIGN KEY ("A") REFERENCES "products"("id") ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT "_ProductToTag_B_fkey" FOREIGN KEY ("B") REFERENCES "tags"("id") ON DELETE CASCADE ON UPDATE CASCADE
);
CREATE UNIQUE INDEX "_ProductToTag_AB_unique" ON "_ProductToTag"("A", "B");
CREATE INDEX "_ProductToTag_B_index" ON "_ProductToTag"("B");

-- Relation Table: _ProductToCollection
CREATE TABLE "_ProductToCollection" (
    "A" TEXT NOT NULL,
    "B" TEXT NOT NULL,
    CONSTRAINT "_ProductToCollection_A_fkey" FOREIGN KEY ("A") REFERENCES "collections"("id") ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT "_ProductToCollection_B_fkey" FOREIGN KEY ("B") REFERENCES "products"("id") ON DELETE CASCADE ON UPDATE CASCADE
);
CREATE UNIQUE INDEX "_ProductToCollection_AB_unique" ON "_ProductToCollection"("A", "B");
CREATE INDEX "_ProductToCollection_B_index" ON "_ProductToCollection"("B");

-- Relation Table: _RelatedProducts (for product self-relation)
CREATE TABLE "_RelatedProducts" (
    "A" TEXT NOT NULL,
    "B" TEXT NOT NULL,
    CONSTRAINT "_RelatedProducts_A_fkey" FOREIGN KEY ("A") REFERENCES "products"("id") ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT "_RelatedProducts_B_fkey" FOREIGN KEY ("B") REFERENCES "products"("id") ON DELETE CASCADE ON UPDATE CASCADE
);
CREATE UNIQUE INDEX "_RelatedProducts_AB_unique" ON "_RelatedProducts"("A", "B");
CREATE INDEX "_RelatedProducts_B_index" ON "_RelatedProducts"("B");


-- Table: orders
CREATE TABLE "orders" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "userId" TEXT NOT NULL,
    "status" "OrderStatus" NOT NULL DEFAULT 'PENDING',
    "subtotal" DECIMAL(10,2) NOT NULL,
    "shippingCost" DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    "tax" DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    "discountAmount" DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    "total" DECIMAL(10,2) NOT NULL,
    "shippingAddress" JSONB NOT NULL,
    "billingAddress" JSONB,
    "paymentMethod" TEXT,
    "paymentIntentId" TEXT UNIQUE,
    "currency" TEXT NOT NULL DEFAULT 'USD',
    "notes" TEXT,
    "trackingNumber" TEXT,
    "shippingMethod" TEXT,
    "refundAmount" DECIMAL(10,2),
    "cancelReason" TEXT,
    "orderNumber" TEXT NOT NULL UNIQUE,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    CONSTRAINT "orders_userId_fkey" FOREIGN KEY ("userId") REFERENCES "users"("id") ON DELETE RESTRICT ON UPDATE CASCADE
);
CREATE INDEX "orders_orderNumber_idx" ON "orders"("orderNumber");

-- Table: order_items
CREATE TABLE "order_items" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "orderId" TEXT NOT NULL,
    "productId" TEXT NOT NULL,
    "variantId" TEXT,
    "name" TEXT NOT NULL,
    "sku" TEXT,
    "price" DECIMAL(10,2) NOT NULL,
    "quantity" INTEGER NOT NULL,
    "subtotal" DECIMAL(10,2) NOT NULL,
    "imageUrl" TEXT,
    "productData" JSONB NOT NULL,
    CONSTRAINT "order_items_orderId_fkey" FOREIGN KEY ("orderId") REFERENCES "orders"("id") ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT "order_items_productId_fkey" FOREIGN KEY ("productId") REFERENCES "products"("id") ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT "order_items_variantId_fkey" FOREIGN KEY ("variantId") REFERENCES "product_variants"("id") ON DELETE RESTRICT ON UPDATE CASCADE
);

-- Table: order_history
CREATE TABLE "order_history" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "orderId" TEXT NOT NULL,
    "status" "OrderStatus" NOT NULL,
    "comment" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "createdBy" TEXT,
    CONSTRAINT "order_history_orderId_fkey" FOREIGN KEY ("orderId") REFERENCES "orders"("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- Table: addresses
CREATE TABLE "addresses" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "userId" TEXT NOT NULL,
    "addressLine1" TEXT NOT NULL,
    "addressLine2" TEXT,
    "city" TEXT NOT NULL,
    "state" TEXT NOT NULL,
    "postalCode" TEXT NOT NULL,
    "country" TEXT NOT NULL,
    "phoneNumber" TEXT,
    "isDefaultShipping" BOOLEAN NOT NULL DEFAULT false,
    "isDefaultBilling" BOOLEAN NOT NULL DEFAULT false,
    "addressType" "AddressType" NOT NULL,
    CONSTRAINT "addresses_userId_fkey" FOREIGN KEY ("userId") REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- Table: reviews
CREATE TABLE "reviews" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "userId" TEXT NOT NULL,
    "productId" TEXT NOT NULL,
    "orderItemId" TEXT UNIQUE,
    "rating" SMALLINT NOT NULL,
    "title" TEXT,
    "comment" TEXT,
    "status" "ReviewStatus" NOT NULL DEFAULT 'PENDING',
    "helpfulCount" INTEGER NOT NULL DEFAULT 0,
    "notHelpfulCount" INTEGER NOT NULL DEFAULT 0,
    "isVerifiedPurchase" BOOLEAN NOT NULL DEFAULT false,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    CONSTRAINT "reviews_userId_fkey" FOREIGN KEY ("userId") REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT "reviews_productId_fkey" FOREIGN KEY ("productId") REFERENCES "products"("id") ON DELETE CASCADE ON UPDATE CASCADE
    -- CONSTRAINT "reviews_orderItemId_fkey" FOREIGN KEY ("orderItemId") REFERENCES "order_items"("id") ON DELETE SET NULL ON UPDATE CASCADE -- If linking to OrderItem
);

-- Table: quiz_questions
CREATE TABLE "quiz_questions" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "question" TEXT NOT NULL,
    "description" TEXT,
    "options" JSONB NOT NULL,
    "order" INTEGER NOT NULL,
    "type" "QuizQuestionType" NOT NULL DEFAULT 'SINGLE_CHOICE_TEXT',
    "imageUrl" TEXT,
    "tooltipText" TEXT
);

-- Table: quiz_responses
CREATE TABLE "quiz_responses" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "userId" TEXT,
    "questionId" TEXT NOT NULL,
    "answer" JSONB NOT NULL,
    "sessionId" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT "quiz_responses_userId_fkey" FOREIGN KEY ("userId") REFERENCES "users"("id") ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT "quiz_responses_questionId_fkey" FOREIGN KEY ("questionId") REFERENCES "quiz_questions"("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- Table: newsletter_subscribers
CREATE TABLE "newsletter_subscribers" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "email" TEXT NOT NULL UNIQUE,
    "name" TEXT,
    "active" BOOLEAN NOT NULL DEFAULT true,
    "source" TEXT,
    "interests" TEXT[],
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Table: cart_items
CREATE TABLE "cart_items" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "userId" TEXT,
    "sessionId" TEXT,
    "productId" TEXT NOT NULL,
    "variantId" TEXT,
    "quantity" INTEGER NOT NULL,
    "addedAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT "cart_items_userId_fkey" FOREIGN KEY ("userId") REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT "cart_items_productId_fkey" FOREIGN KEY ("productId") REFERENCES "products"("id") ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT "cart_items_variantId_fkey" FOREIGN KEY ("variantId") REFERENCES "product_variants"("id") ON DELETE SET NULL ON UPDATE CASCADE
);
CREATE UNIQUE INDEX "cart_items_guestCartUniqueItem_key" ON "cart_items"("sessionId", "productId", "variantId");
CREATE UNIQUE INDEX "cart_items_userCartUniqueItem_key" ON "cart_items"("userId", "productId", "variantId");

-- Table: wishlist_items
CREATE TABLE "wishlist_items" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "userId" TEXT NOT NULL,
    "productId" TEXT NOT NULL,
    "variantId" TEXT,
    "addedAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT "wishlist_items_userId_fkey" FOREIGN KEY ("userId") REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT "wishlist_items_productId_fkey" FOREIGN KEY ("productId") REFERENCES "products"("id") ON DELETE CASCADE ON UPDATE CASCADE
    -- CONSTRAINT "wishlist_items_variantId_fkey" FOREIGN KEY ("variantId") REFERENCES "product_variants"("id") ON DELETE SET NULL ON UPDATE CASCADE
);
CREATE UNIQUE INDEX "wishlist_items_userId_productId_variantId_key" ON "wishlist_items"("userId", "productId", "variantId");

-- Table: product_subscriptions
CREATE TABLE "product_subscriptions" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "userId" TEXT NOT NULL,
    "productId" TEXT NOT NULL,
    "variantId" TEXT,
    "frequency" "SubscriptionFrequency" NOT NULL,
    "status" "SubscriptionStatus" NOT NULL DEFAULT 'ACTIVE',
    "nextBillingDate" TIMESTAMP(3),
    "nextShipDate" TIMESTAMP(3),
    "lastBilledDate" TIMESTAMP(3),
    "lastShippedDate" TIMESTAMP(3),
    "stripeSubscriptionId" TEXT UNIQUE,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "cancelledAt" TIMESTAMP(3),
    CONSTRAINT "product_subscriptions_userId_fkey" FOREIGN KEY ("userId") REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT "product_subscriptions_productId_fkey" FOREIGN KEY ("productId") REFERENCES "products"("id") ON DELETE CASCADE ON UPDATE CASCADE
    -- CONSTRAINT "product_subscriptions_variantId_fkey" FOREIGN KEY ("variantId") REFERENCES "product_variants"("id") ON DELETE SET NULL ON UPDATE CASCADE
);

-- Table: loyalty_tiers
CREATE TABLE "loyalty_tiers" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "name" TEXT NOT NULL UNIQUE,
    "minPoints" INTEGER NOT NULL UNIQUE,
    "benefits" JSONB NOT NULL,
    "color" TEXT,
    "icon" TEXT
);

-- Table: loyalty_point_logs
CREATE TABLE "loyalty_point_logs" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "userId" TEXT NOT NULL,
    "points" INTEGER NOT NULL,
    "type" "LoyaltyPointLogType" NOT NULL,
    "description" TEXT NOT NULL,
    "orderId" TEXT,
    "userRewardId" TEXT,
    "expiresAt" TIMESTAMP(3),
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT "loyalty_point_logs_userId_fkey" FOREIGN KEY ("userId") REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT "loyalty_point_logs_orderId_fkey" FOREIGN KEY ("orderId") REFERENCES "orders"("id") ON DELETE SET NULL ON UPDATE CASCADE
    -- UserReward FK will be added after UserReward table
);

-- Table: rewards
CREATE TABLE "rewards" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "name" TEXT NOT NULL,
    "description" TEXT,
    "pointsCost" INTEGER NOT NULL,
    "type" "RewardType" NOT NULL,
    "value" JSONB NOT NULL,
    "requiredTierId" TEXT,
    "imageUrl" TEXT,
    "isActive" BOOLEAN NOT NULL DEFAULT true,
    "validFrom" TIMESTAMP(3),
    "validUntil" TIMESTAMP(3),
    "maxRedemptions" INTEGER,
    "maxRedemptionsPerUser" INTEGER DEFAULT 1,
    "freeProductId" TEXT,
    CONSTRAINT "rewards_requiredTierId_fkey" FOREIGN KEY ("requiredTierId") REFERENCES "loyalty_tiers"("id") ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT "rewards_freeProductId_fkey" FOREIGN KEY ("freeProductId") REFERENCES "products"("id") ON DELETE SET NULL ON UPDATE CASCADE
);

-- Table: user_rewards
CREATE TABLE "user_rewards" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "userId" TEXT NOT NULL,
    "rewardId" TEXT NOT NULL,
    "redeemedAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "status" "UserRewardStatus" NOT NULL DEFAULT 'AVAILABLE',
    "couponCode" TEXT UNIQUE,
    "expiresAt" TIMESTAMP(3),
    "orderId" TEXT,
    CONSTRAINT "user_rewards_userId_fkey" FOREIGN KEY ("userId") REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT "user_rewards_rewardId_fkey" FOREIGN KEY ("rewardId") REFERENCES "rewards"("id") ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT "user_rewards_orderId_fkey" FOREIGN KEY ("orderId") REFERENCES "orders"("id") ON DELETE SET NULL ON UPDATE CASCADE
);
ALTER TABLE "loyalty_point_logs" ADD CONSTRAINT "loyalty_point_logs_userRewardId_fkey" FOREIGN KEY ("userRewardId") REFERENCES "user_rewards"("id") ON DELETE SET NULL ON UPDATE CASCADE;

-- Table: role_definitions (Advanced RBAC)
CREATE TABLE "role_definitions" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "name" TEXT NOT NULL UNIQUE,
    "description" TEXT,
    "isSystemRole" BOOLEAN NOT NULL DEFAULT false
);
ALTER TABLE "users" ADD CONSTRAINT "users_roleDefinitionId_fkey" FOREIGN KEY ("roleDefinitionId") REFERENCES "role_definitions"("id") ON DELETE SET NULL ON UPDATE CASCADE;

-- Table: permissions (Advanced RBAC)
CREATE TABLE "permissions" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "action" TEXT NOT NULL,
    "subject" TEXT NOT NULL,
    "category" TEXT NOT NULL,
    "description" TEXT
);
CREATE UNIQUE INDEX "permissions_action_subject_key" ON "permissions"("action", "subject");

-- Table: permission_assignments (Advanced RBAC - Join table)
CREATE TABLE "permission_assignments" (
    "roleId" TEXT NOT NULL,
    "permissionId" TEXT NOT NULL,
    PRIMARY KEY ("roleId", "permissionId"),
    CONSTRAINT "permission_assignments_roleId_fkey" FOREIGN KEY ("roleId") REFERENCES "role_definitions"("id") ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT "permission_assignments_permissionId_fkey" FOREIGN KEY ("permissionId") REFERENCES "permissions"("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- Table: suppliers (Inventory)
CREATE TABLE "suppliers" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "name" TEXT NOT NULL UNIQUE,
    "contactName" TEXT,
    "contactEmail" TEXT UNIQUE,
    "contactPhone" TEXT,
    "address" JSONB,
    "notes" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL
);

-- Table: purchase_orders (Inventory)
CREATE TABLE "purchase_orders" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "orderNumber" TEXT NOT NULL UNIQUE,
    "supplierId" TEXT NOT NULL,
    "status" "PurchaseOrderStatus" NOT NULL DEFAULT 'DRAFT',
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "expectedDeliveryDate" TIMESTAMP(3),
    "actualDeliveryDate" TIMESTAMP(3),
    "shippingCost" DECIMAL(10,2),
    "subtotal" DECIMAL(12,2) NOT NULL DEFAULT 0.00,
    "totalCost" DECIMAL(12,2) NOT NULL DEFAULT 0.00,
    "notes" TEXT,
    "createdById" TEXT,
    "updatedById" TEXT,
    CONSTRAINT "purchase_orders_supplierId_fkey" FOREIGN KEY ("supplierId") REFERENCES "suppliers"("id") ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT "purchase_orders_createdById_fkey" FOREIGN KEY ("createdById") REFERENCES "users"("id") ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT "purchase_orders_updatedById_fkey" FOREIGN KEY ("updatedById") REFERENCES "users"("id") ON DELETE SET NULL ON UPDATE CASCADE
);

-- Table: purchase_order_items (Inventory)
CREATE TABLE "purchase_order_items" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "purchaseOrderId" TEXT NOT NULL,
    "productId" TEXT NOT NULL,
    "quantityOrdered" INTEGER NOT NULL,
    "quantityReceived" INTEGER NOT NULL DEFAULT 0,
    "unitCost" DECIMAL(10,2) NOT NULL,
    CONSTRAINT "purchase_order_items_purchaseOrderId_fkey" FOREIGN KEY ("purchaseOrderId") REFERENCES "purchase_orders"("id") ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT "purchase_order_items_productId_fkey" FOREIGN KEY ("productId") REFERENCES "products"("id") ON DELETE RESTRICT ON UPDATE CASCADE
);

-- Table: smart_home_platform_connections (Smart Home)
CREATE TABLE "smart_home_platform_connections" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "userId" TEXT NOT NULL,
    "platformKey" TEXT NOT NULL,
    "platformName" TEXT NOT NULL,
    "accessToken" TEXT NOT NULL,
    "refreshToken" TEXT,
    "tokenExpiresAt" TIMESTAMP(3),
    "scopesGranted" TEXT[],
    "externalUserId" TEXT,
    "lastSyncedAt" TIMESTAMP(3),
    "syncStatus" TEXT,
    "syncMessage" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    CONSTRAINT "smart_home_platform_connections_userId_fkey" FOREIGN KEY ("userId") REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE CASCADE
);
CREATE UNIQUE INDEX "smart_home_platform_connections_userId_platformKey_key" ON "smart_home_platform_connections"("userId", "platformKey");

-- Table: smart_home_devices (Smart Home)
CREATE TABLE "smart_home_devices" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "connectionId" TEXT NOT NULL,
    "externalDeviceId" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "type" "SmartHomeDeviceType" NOT NULL,
    "roomName" TEXT,
    "isOnline" BOOLEAN NOT NULL DEFAULT false,
    "isActive" BOOLEAN NOT NULL DEFAULT false,
    "capabilities" JSONB,
    "currentState" JSONB,
    "currentScentProductId" TEXT,
    "lastActivityAt" TIMESTAMP(3),
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    CONSTRAINT "smart_home_devices_connectionId_fkey" FOREIGN KEY ("connectionId") REFERENCES "smart_home_platform_connections"("id") ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT "smart_home_devices_currentScentProductId_fkey" FOREIGN KEY ("currentScentProductId") REFERENCES "products"("id") ON DELETE SET NULL ON UPDATE CASCADE
);
CREATE UNIQUE INDEX "smart_home_devices_connectionId_externalDeviceId_key" ON "smart_home_devices"("connectionId", "externalDeviceId");

-- Table: automation_rules (Smart Home)
CREATE TABLE "automation_rules" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "userId" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "description" TEXT,
    "enabled" BOOLEAN NOT NULL DEFAULT true,
    "triggerType" "AutomationTriggerType" NOT NULL,
    "triggerConfig" JSONB NOT NULL,
    "lastTriggered" TIMESTAMP(3),
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    CONSTRAINT "automation_rules_userId_fkey" FOREIGN KEY ("userId") REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- Table: automation_actions (Smart Home)
CREATE TABLE "automation_actions" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "ruleId" TEXT NOT NULL,
    "deviceId" TEXT NOT NULL,
    "actionType" TEXT NOT NULL,
    "parameters" JSONB,
    "executionOrder" INTEGER NOT NULL DEFAULT 0,
    CONSTRAINT "automation_actions_ruleId_fkey" FOREIGN KEY ("ruleId") REFERENCES "automation_rules"("id") ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT "automation_actions_deviceId_fkey" FOREIGN KEY ("deviceId") REFERENCES "smart_home_devices"("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- Table: scent_schedules (Smart Home)
CREATE TABLE "scent_schedules" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "userId" TEXT NOT NULL,
    "deviceId" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "description" TEXT,
    "enabled" BOOLEAN NOT NULL DEFAULT true,
    "entries" JSONB NOT NULL, -- Array of { id: string, scentProductId: string, startTime: "HH:mm", endTime: "HH:mm", daysOfWeek: number[], intensity?: number }
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    CONSTRAINT "scent_schedules_userId_fkey" FOREIGN KEY ("userId") REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT "scent_schedules_deviceId_fkey" FOREIGN KEY ("deviceId") REFERENCES "smart_home_devices"("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- Table: notifications
CREATE TABLE "notifications" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "userId" TEXT NOT NULL,
    "type" "NotificationType" NOT NULL,
    "title" TEXT NOT NULL,
    "message" TEXT NOT NULL,
    "isRead" BOOLEAN NOT NULL DEFAULT false,
    "readAt" TIMESTAMP(3),
    "link" TEXT,
    "data" JSONB,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT "notifications_userId_fkey" FOREIGN KEY ("userId") REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- Table: site_settings (Singleton table)
CREATE TABLE "site_settings" (
    "id" TEXT NOT NULL PRIMARY KEY DEFAULT 'global_settings',
    "siteName" TEXT NOT NULL DEFAULT 'The Scent',
    "logoUrl" TEXT,
    "faviconUrl" TEXT,
    "primaryColor" TEXT NOT NULL DEFAULT '#2a7c8a',
    "secondaryColor" TEXT NOT NULL DEFAULT '#e0a86f',
    "accentColor" TEXT NOT NULL DEFAULT '#ff7b4f',
    "defaultCurrency" TEXT NOT NULL DEFAULT 'USD',
    "defaultLanguage" TEXT NOT NULL DEFAULT 'en',
    "contactEmail" TEXT,
    "contactPhone" TEXT,
    "socialLinks" JSONB,
    "shippingMethods" JSONB,
    "taxRates" JSONB,
    "defaultMetaTitle" TEXT,
    "defaultMetaDescription" TEXT,
    "maintenanceMode" BOOLEAN NOT NULL DEFAULT false,
    "storeAddress" JSONB,
    "updatedAt" TIMESTAMP(3) NOT NULL
);

-- Insert default site settings if not exists
INSERT INTO "site_settings" ("id", "updatedAt") VALUES ('global_settings', CURRENT_TIMESTAMP) ON CONFLICT ("id") DO NOTHING;

```

# src/styles/globals.css
```css
/* src/styles/globals.css */
@tailwind base;
@tailwind components;
@tailwind utilities;

/*
  Google Fonts are imported via <link> tags in src/app/layout.tsx:
  - Cormorant Garamond: var(--font-head)
  - Montserrat: var(--font-body)
  - Raleway: var(--font-accent)
*/

@layer base {
  :root {
    /* --- Font Variables --- */
    --font-head: 'Cormorant Garamond', serif;
    --font-body: 'Montserrat', sans-serif;
    --font-accent: 'Raleway', sans-serif;

    /* --- LIGHT MODE THEME COLORS (Ensure HSL values are space-separated numbers/percentages) --- */
    /* Replace these with YOUR ACCURATE HSL conversions from your design */
    --theme-bg-light: 44 22% 97%;         /* Original: #f8f7f4 */
    --theme-bg-alt-light: 0 0% 100%;      /* Original: #ffffff */
    --theme-text-light: 202 13% 23%;      /* Original: #333d41 */
    --theme-primary-light: 188 53% 35%;   /* Original: #2a7c8a */
    --theme-accent-light: 32 60% 66%;     /* Original: #e0a86f (sample's HTML accent) */
    --theme-cta-light: 17 100% 65%;       /* Original: #ff7b4f (sample's HTML cta) */

    /* --- Shadcn/ui style CSS Variables (Light Mode) --- */
    --background: var(--theme-bg-light);
    --foreground: var(--theme-text-light);
    
    --card: var(--theme-bg-alt-light);
    --card-foreground: var(--theme-text-light);

    --popover: var(--theme-bg-alt-light);
    --popover-foreground: var(--theme-text-light);

    --primary: var(--theme-primary-light);
    --primary-foreground: 0 0% 100%; /* White text on primary */
    
    --secondary: var(--theme-accent-light);     
    --secondary-foreground: 202 13% 23%; /* Dark text for contrast on this secondary */

    --muted: 210 40% 96.1%; 
    --muted-foreground: 215 20% 45%; /* Slightly darker for better contrast */

    --accent: var(--theme-cta-light);           
    --accent-foreground: 0 0% 100%;          

    --destructive: 0 84.2% 60.2%;
    --destructive-foreground: 0 0% 100%;

    --border: 214 31.8% 88%; /* Slightly darker for better visibility */
    --input: 214 31.8% 88%;  
    --ring: var(--primary); 

    --radius: 0.5rem;
  }

  .dark {
    /* --- DARK MODE THEME COLORS (Ensure HSL values are space-separated) --- */
    /* Replace these with YOUR ACCURATE HSL conversions */
    --theme-bg-dark: 220 21% 14%;         /* Original: #1a202c */
    --theme-bg-alt-dark: 221 23% 23%;     /* Original: #2d3748 */
    --theme-text-dark: 214 28% 90%;       /* Original: #e2e8f0 */
    --theme-primary-dark: 174 56% 57%;    /* Original: #4fd1c5 */
    --theme-accent-dark: 33 89% 65%;      /* Original: #f6ad55 */
    --theme-cta-dark: 15 100% 71%;        /* Original: #ff8c69 */

    /* --- Shadcn/ui style CSS Variables (Dark Mode) --- */
    --background: var(--theme-bg-dark);
    --foreground: var(--theme-text-dark);

    --card: var(--theme-bg-alt-dark);
    --card-foreground: var(--theme-text-dark);

    --popover: var(--theme-bg-alt-dark);
    --popover-foreground: var(--theme-text-dark);

    --primary: var(--theme-primary-dark);
    --primary-foreground: 220 21% 10%; /* Darker text for contrast */
    
    --secondary: var(--theme-accent-dark);
    --secondary-foreground: 220 21% 10%; 

    --muted: 217 33% 17.5%; 
    --muted-foreground: 215 20% 65.1%; 
    
    --accent: var(--theme-cta-dark);
    --accent-foreground: 220 21% 10%; 

    --destructive: 0 62.8% 30.6%; 
    --destructive-foreground: 0 0% 100%;

    --border: 217 33% 25.5%; /* Slightly adjusted */
    --input: 217 33% 25.5%;  
    --ring: var(--primary);
  }
}

/* Base HTML and Body styles */
@layer base {
  * {
    @apply border-border; /* Applies default border color */
  }
  html {
    @apply scroll-smooth;
    font-family: var(--font-body); /* Default font for the entire document */
    /* Base text and background colors applied directly for full coverage */
    color: hsl(var(--foreground)); 
    background-color: hsl(var(--background));
  }
  body {
    @apply text-base; /* Tailwind's base font size */
    line-height: 1.7;
    min-height: 100dvh; 
    text-rendering: optimizeLegibility;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    display: flex; 
    flex-direction: column; 
    /* Ensure body itself also gets Tailwind classes if html direct styles are not enough */
    @apply bg-background text-foreground; 
  }

  /* Headings using the --font-head variable */
  h1, h2, h3, h4, h5, h6 {
    font-family: var(--font-head); 
    @apply font-bold tracking-tight text-foreground; /* Default to foreground */
    /* For primary color headings, apply 'text-primary' utility class directly in JSX */
    line-height: 1.25; 
    margin-bottom: 0.75em; /* Consistent spacing */
  }

  /* Link styles */
  a {
    @apply text-primary font-medium transition-colors duration-200 ease-in-out;
    /* Use font-accent for specific links if needed: className="font-accent" */
  }
  a:hover {
    @apply text-accent opacity-90; /* Uses the CTA-mapped accent color for hover */
  }
  a:focus-visible { /* Enhanced focus visibility */
    @apply outline-none ring-2 ring-ring ring-offset-2 ring-offset-background rounded-sm;
  }
}

```

# src/app/account/profile/page.tsx
```tsx
// src/app/account/profile/page.tsx
import { type Metadata } from "next";
import { auth } from "~/server/auth";
import { redirect } from "next/navigation";
// import UserProfileClient from "./UserProfileClient"; // Component to handle form and updates

export const metadata: Metadata = {
  title: "My Profile - The Scent",
  description: "View and update your personal information and preferences.",
};

export default async function ProfilePage() {
  const session = await auth();
  if (!session?.user) {
    redirect("/auth/signin?callbackUrl=/account/profile");
  }

  // const serverApi = await createServerActionClient();
  // const userProfile = await serverApi.users.getProfile.query(); // Assuming this procedure exists

  return (
    <div className="rounded-lg border border-border bg-card p-6 shadow-sm">
      <h2 className="text-2xl font-semibold text-foreground mb-6">My Profile</h2>
      {/* <UserProfileClient initialProfile={userProfile} /> */}
      <div className="space-y-4">
        <div>
            <p className="text-sm text-muted-foreground">Name</p>
            <p className="text-foreground">{session.user.name || "Not set"}</p>
        </div>
        <div>
            <p className="text-sm text-muted-foreground">Email</p>
            <p className="text-foreground">{session.user.email || "Not set"}</p>
        </div>
        <div>
            <p className="text-sm text-muted-foreground">Role</p>
            <p className="text-foreground capitalize">{session.user.role?.toLowerCase() || "Customer"}</p>
        </div>
        <p className="text-sm text-muted-foreground pt-4">
            (Profile editing form placeholder. This page would typically render a client component 
            for form interactions and tRPC mutations to update profile data.)
        </p>
      </div>
    </div>
  );
}
```

# src/app/account/layout.tsx
```tsx
// src/app/account/layout.tsx
import { type ReactNode, Suspense } from "react";
import { redirect } from "next/navigation";
import Link from "next/link";
import { auth } from "~/server/auth"; // NextAuth.js v5 auth function
import { FaUser, FaBoxOpen, FaHeart, FaGift, FaCreditCard, FaCog, FaSignOutAlt } from "react-icons/fa"; // Example icons
import AccountSidebarNavClient from "./AccountSidebarNavClient"; // Client component for interactive sidebar

export const metadata = {
  title: "My Account - The Scent",
  description: "Manage your account, orders, subscriptions, and preferences at The Scent.",
};

const accountNavItems = [
  { href: "/account/profile", label: "Profile", icon: <FaUser /> },
  { href: "/account/orders", label: "Orders", icon: <FaBoxOpen /> },
  { href: "/account/subscriptions", label: "Subscriptions", icon: <FaCog /> }, // Using FaCog for subscriptions
  { href: "/account/wishlist", label: "Wishlist", icon: <FaHeart /> },
  { href: "/account/loyalty", label: "Loyalty & Rewards", icon: <FaGift /> },
  { href: "/account/payment-methods", label: "Payment Methods", icon: <FaCreditCard /> }, // Example new page
  { href: "/account/addresses", label: "Addresses", icon: <FaCog /> }, // Example new page
  // Add more account links as needed
];

export default async function AccountLayout({ children }: { children: ReactNode }) {
  const session = await auth();

  if (!session?.user) {
    // Construct the callbackUrl dynamically based on the current path
    // This requires access to the path, which is not directly available here.
    // Middleware is a better place for dynamic callbackUrls or use a fixed one.
    redirect(`/auth/signin?callbackUrl=/account/profile`); // Redirect to profile after sign-in
  }

  return (
    <div className="container mx-auto px-4 py-8 md:py-12">
      <div className="mb-8">
        <h1 className="text-3xl font-bold tracking-tight text-foreground">My Account</h1>
        <p className="text-muted-foreground">Welcome back, {session.user.name || "Scent Lover"}!</p>
      </div>

      <div className="flex flex-col md:flex-row gap-8 lg:gap-12">
        <aside className="w-full md:w-64 lg:w-72 flex-shrink-0">
          <AccountSidebarNavClient navItems={accountNavItems} />
        </aside>
        <main className="flex-1 min-w-0"> {/* min-w-0 is important for flex children to shrink correctly */}
          <Suspense fallback={<div className="p-8 text-center">Loading account details...</div>}>
            {children}
          </Suspense>
        </main>
      </div>
    </div>
  );
}
```

# src/app/account/AccountSidebarNavClient.tsx
```tsx
// src/app/account/AccountSidebarNavClient.tsx
"use client";

import Link from "next/link";
import { usePathname } from "next/navigation";
import { signOut } from "next-auth/react";
import { Button } from "~/components/ui/Button";
import { cn } from "~/lib/utils";
import { FaSignOutAlt } from "react-icons/fa";
import { type ReactNode } from "react";

interface NavItem {
  href: string;
  label: string;
  icon: ReactNode;
}

interface AccountSidebarNavClientProps {
  navItems: NavItem[];
}

export default function AccountSidebarNavClient({ navItems }: AccountSidebarNavClientProps) {
  const pathname = usePathname();

  return (
    <nav className="flex flex-col space-y-1 rounded-md border border-border bg-card p-4 shadow-sm">
      {navItems.map((item) => (
        <Link
          key={item.href}
          href={item.href}
          className={cn(
            "flex items-center gap-3 rounded-md px-3 py-2.5 text-sm font-medium transition-colors hover:bg-muted hover:text-primary",
            pathname === item.href
              ? "bg-primary/10 text-primary"
              : "text-muted-foreground"
          )}
        >
          <span className="w-5 h-5">{item.icon}</span>
          {item.label}
        </Link>
      ))}
      <div className="!mt-4 pt-4 border-t border-border">
        <Button
          variant="ghost"
          onClick={() => signOut({ callbackUrl: '/' })} // Redirect to home after sign out
          className="w-full justify-start gap-3 px-3 py-2.5 text-sm font-medium text-muted-foreground hover:bg-destructive/10 hover:text-destructive"
        >
          <FaSignOutAlt className="w-5 h-5" />
          Sign Out
        </Button>
      </div>
    </nav>
  );
}
```

# src/app/account/subscriptions/page.tsx
```tsx
// src/app/account/subscriptions/page.tsx
import { type Metadata } from "next";
import { auth } from "~/server/auth";
import { redirect } from "next/navigation";
import SubscriptionManager from "~/components/subscription/SubscriptionManager"; // The client component

export const metadata: Metadata = {
  title: "My Subscriptions - The Scent",
  description: "Manage your product subscriptions and recurring deliveries.",
};

export default async function SubscriptionsPage() {
  const session = await auth();
  if (!session?.user) {
    redirect("/auth/signin?callbackUrl=/account/subscriptions");
  }

  return (
    <div> {/* No extra card wrapper here, SubscriptionManager might have its own */}
      <SubscriptionManager />
    </div>
  );
}
```

# src/app/account/orders/page.tsx
```tsx
// src/app/account/orders/page.tsx
import { type Metadata } from "next";
import Link from "next/link";
import { redirect } from "next/navigation";
import { createServerActionClient } from "~/trpc/server";
import { auth } from "~/server/auth"; // NextAuth.js v5 auth function
import { Button } from "~/components/ui/Button";
import { Badge } from "~/components/ui/Badge"; // Assuming Badge UI component
import { formatCurrency, formatDate } from "~/utils/format";
import { FaBoxOpen, FaExternalLinkAlt } from "react-icons/fa";

export const metadata: Metadata = {
  title: "My Orders - The Scent",
  description: "View your order history, track shipments, and manage your purchases.",
};

export default async function AccountOrdersPage() {
  const session = await auth();
  if (!session?.user) {
    redirect("/auth/signin?callbackUrl=/account/orders");
  }

  const serverApi = await createServerActionClient();
  // Fetch user's orders - assuming ordersRouter.getUserOrders exists
  const ordersData = await serverApi.orders.getUserOrders.query({ limit: 10 }); // Example limit

  return (
    <div className="container mx-auto px-4 py-8">
      <h1 className="text-3xl font-bold tracking-tight text-foreground mb-8">My Orders</h1>

      {ordersData.orders.length === 0 ? (
        <div className="text-center py-12 border border-dashed border-border rounded-lg bg-card">
          <FaBoxOpen className="mx-auto h-12 w-12 text-muted-foreground mb-4" />
          <h2 className="text-xl font-semibold text-foreground mb-2">No Orders Yet</h2>
          <p className="text-muted-foreground mb-6">You haven't placed any orders with us yet. Start exploring our collection!</p>
          <Button asChild>
            <Link href="/products">Shop Now</Link>
          </Button>
        </div>
      ) : (
        <div className="space-y-6">
          {ordersData.orders.map((order) => (
            <div key={order.id} className="rounded-lg border border-border bg-card shadow-sm overflow-hidden">
              <div className="p-4 sm:p-6 bg-muted/50 dark:bg-card-foreground/5 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
                <div>
                  <h2 className="text-lg font-semibold text-foreground">Order #{order.orderNumber}</h2>
                  <p className="text-sm text-muted-foreground">
                    Placed on: {formatDate(order.createdAt)}
                  </p>
                </div>
                <div className="flex items-center gap-2">
                    <Badge variant={
                        order.status === "DELIVERED" || order.status === "COMPLETED" ? "success" :
                        order.status === "SHIPPED" || order.status === "IN_TRANSIT" ? "default" :
                        order.status === "CANCELLED" || order.status === "FAILED" ? "destructive" :
                        "secondary"
                    }>
                        {order.status.toString().replace(/_/g, ' ').toLocaleUpperCase()}
                    </Badge>
                    <span className="text-lg font-semibold text-foreground">{formatCurrency(order.total, order.currency)}</span>
                </div>
              </div>
              <div className="p-4 sm:p-6">
                {/* Display a few items or summary */}
                {order.orderItems.slice(0, 2).map(item => (
                    <div key={item.id} className="flex items-center gap-4 py-2 border-b border-border last:border-b-0">
                        {item.imageUrl && <Image src={item.imageUrl} alt={item.name} width={48} height={48} className="rounded object-cover h-12 w-12"/>}
                        <div className="flex-grow">
                            <p className="text-sm font-medium text-foreground">{item.name}</p>
                            <p className="text-xs text-muted-foreground">Qty: {item.quantity}</p>
                        </div>
                        <p className="text-sm text-foreground">{formatCurrency(item.price * item.quantity, order.currency)}</p>
                    </div>
                ))}
                {order.orderItems.length > 2 && <p className="text-xs text-muted-foreground mt-2">...and {order.orderItems.length - 2} more items</p>}
              </div>
              <div className="p-4 sm:p-6 border-t border-border bg-muted/30 dark:bg-card-foreground/5 flex justify-end">
                <Button asChild variant="outline" size="sm">
                  <Link href={`/account/orders/${order.id}`}>
                    View Details <FaExternalLinkAlt className="ml-2 h-3 w-3"/>
                  </Link>
                </Button>
              </div>
            </div>
          ))}
          {/* TODO: Pagination for orders */}
        </div>
      )}
    </div>
  );
}
```

# src/app/account/orders/[id]/page.tsx
```tsx
// src/app/account/orders/[id]/page.tsx
import { type Metadata } from "next";
import { notFound, redirect } from "next/navigation";
import Link from "next/link";
import { createServerActionClient } from "~/trpc/server";
import { auth } from "~/server/auth";
import { Button } from "~/components/ui/Button";
import { Badge } from "~/components/ui/Badge";
import { formatCurrency, formatDate } from "~/utils/format";
import Image from "next/image";
import { FaArrowLeft, FaPrint } from "react-icons/fa";

interface OrderDetailPageProps {
  params: { id: string }; // Order ID from the URL
}

// Dynamic metadata based on the order
export async function generateMetadata({ params }: OrderDetailPageProps): Promise<Metadata> {
  const session = await auth();
  if (!session?.user) return { title: "Order Details - Sign In Required" }; // Or handle redirect earlier

  const serverApi = await createServerActionClient();
  try {
    const order = await serverApi.orders.getOrderById.query({ id: params.id });
    if (!order || order.userId !== session.user.id) { // Ensure user owns the order
      return { title: "Order Not Found" };
    }
    return {
      title: `Order #${order.orderNumber} - The Scent`,
      description: `Details for your order #${order.orderNumber} placed on ${formatDate(order.createdAt)}.`,
    };
  } catch (error) {
    return { title: "Error Loading Order" };
  }
}

export default async function OrderDetailPage({ params }: OrderDetailPageProps) {
  const session = await auth();
  if (!session?.user) {
    redirect(`/auth/signin?callbackUrl=/account/orders/${params.id}`);
  }

  const serverApi = await createServerActionClient();
  let order;
  try {
    order = await serverApi.orders.getOrderById.query({ id: params.id });
  } catch (error) {
    console.error("Error fetching order details:", error);
    // Handle specific TRPC errors if needed, e.g., NOT_FOUND
    if ((error as any).code === 'NOT_FOUND') notFound();
    // For other errors, you might show a generic error message or redirect
    return <div className="container p-8 text-center text-destructive">Error loading order details.</div>;
  }

  if (!order || order.userId !== session.user.id) { // Final check for ownership
    notFound();
  }

  const shippingAddr = order.shippingAddress as { fullName: string, addressLine1: string, addressLine2?: string, city: string, state: string, zipCode: string, country: string, phone?:string };
  // const billingAddr = order.billingAddress as { ... } | null; // Similar type for billing if used

  return (
    <div className="container mx-auto px-4 py-8">
      <div className="mb-6 flex items-center justify-between">
        <div>
            <Link href="/account/orders" className="inline-flex items-center text-sm text-primary hover:underline mb-2">
                <FaArrowLeft className="mr-2 h-3 w-3" /> Back to Orders
            </Link>
            <h1 className="text-3xl font-bold tracking-tight text-foreground">
                Order Details
            </h1>
            <p className="text-muted-foreground">Order #{order.orderNumber} &bull; Placed on {formatDate(order.createdAt)}</p>
        </div>
        <Button variant="outline" size="sm" onClick={() => typeof window !== "undefined" && window.print()}>
            <FaPrint className="mr-2 h-4 w-4"/> Print Invoice
        </Button>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        {/* Order Items & Summary */}
        <div className="lg:col-span-2 space-y-6">
            <div className="rounded-lg border border-border bg-card shadow-sm">
                <h2 className="text-xl font-semibold text-foreground p-4 sm:p-6 border-b border-border">Items Ordered ({order.orderItems.length})</h2>
                <ul role="list" className="divide-y divide-border">
                    {order.orderItems.map((item) => (
                    <li key={item.id} className="flex py-4 sm:py-6 px-4 sm:px-6">
                        {item.imageUrl && (
                            <div className="h-20 w-20 flex-shrink-0 overflow-hidden rounded-md border border-border sm:h-24 sm:w-24">
                                <Image
                                src={item.imageUrl}
                                alt={item.name} // productData might have better alt
                                width={96}
                                height={96}
                                className="h-full w-full object-cover object-center"
                                />
                            </div>
                        )}
                        <div className="ml-4 flex flex-1 flex-col">
                        <div>
                            <div className="flex justify-between text-base font-medium text-foreground">
                            <h3>
                                <Link href={`/products/${(item.productData as any)?.slug || '#'}`}>{item.name}</Link>
                            </h3>
                            <p className="ml-4">{formatCurrency(item.price * item.quantity, order.currency)}</p>
                            </div>
                            {/* {(item.productData as any)?.variantName && <p className="mt-1 text-sm text-muted-foreground">{(item.productData as any).variantName}</p>} */}
                            <p className="mt-1 text-sm text-muted-foreground">Price: {formatCurrency(item.price, order.currency)}</p>
                        </div>
                        <div className="flex flex-1 items-end justify-between text-sm">
                            <p className="text-muted-foreground">Qty: {item.quantity}</p>
                            {/* Add remove/actions if applicable and order is mutable */}
                        </div>
                        </div>
                    </li>
                    ))}
                </ul>
                 <div className="border-t border-border px-4 py-6 sm:px-6 space-y-2">
                    <div className="flex justify-between text-sm text-muted-foreground">
                        <p>Subtotal</p><p>{formatCurrency(order.subtotal, order.currency)}</p>
                    </div>
                    {order.discountAmount > 0 && (
                        <div className="flex justify-between text-sm text-muted-foreground">
                        <p>Discount</p><p className="text-green-600">-{formatCurrency(order.discountAmount, order.currency)}</p>
                        </div>
                    )}
                    <div className="flex justify-between text-sm text-muted-foreground">
                        <p>Shipping</p><p>{formatCurrency(order.shippingCost, order.currency)}</p>
                    </div>
                    <div className="flex justify-between text-sm text-muted-foreground">
                        <p>Tax</p><p>{formatCurrency(order.tax, order.currency)}</p>
                    </div>
                    <div className="flex justify-between text-base font-medium text-foreground">
                        <p>Total</p><p>{formatCurrency(order.total, order.currency)}</p>
                    </div>
                </div>
            </div>
        </div>

        {/* Shipping & Status */}
        <div className="space-y-6 lg:sticky lg:top-24 self-start">
            <div className="rounded-lg border border-border bg-card p-6 shadow-sm">
                <h2 className="text-xl font-semibold text-foreground mb-4">Order Status</h2>
                <Badge variant={
                    order.status === "DELIVERED" || order.status === "COMPLETED" ? "success" :
                    order.status === "SHIPPED" || order.status === "IN_TRANSIT" ? "default" :
                    order.status === "CANCELLED" || order.status === "FAILED" ? "destructive" :
                    "secondary"
                } className="text-sm px-3 py-1">
                    {order.status.toString().replace(/_/g, ' ').toLocaleUpperCase()}
                </Badge>
                {order.trackingNumber && (
                    <p className="mt-3 text-sm text-muted-foreground">
                        Tracking: <span className="text-primary font-medium">{order.trackingNumber}</span>
                        {/* TODO: Add link to tracking provider if possible */}
                    </p>
                )}
            </div>
            <div className="rounded-lg border border-border bg-card p-6 shadow-sm">
                <h2 className="text-xl font-semibold text-foreground mb-4">Shipping Address</h2>
                <address className="not-italic text-sm text-muted-foreground space-y-0.5">
                    <p className="font-medium text-foreground">{shippingAddr.fullName}</p>
                    <p>{shippingAddr.addressLine1}</p>
                    {shippingAddr.addressLine2 && <p>{shippingAddr.addressLine2}</p>}
                    <p>{shippingAddr.city}, {shippingAddr.state} {shippingAddr.zipCode}</p>
                    <p>{shippingAddr.country}</p>
                    {shippingAddr.phone && <p>Phone: {shippingAddr.phone}</p>}
                </address>
            </div>
            {/* Optional: Billing Address, Payment Method */}
        </div>
      </div>
    </div>
  );
}
```

# src/app/unauthorized/page.tsx
```tsx
// src/app/unauthorized/page.tsx
import { type Metadata } from "next";
import Link from "next/link";
import { Button } from "~/components/ui/Button";
import { FaExclamationTriangle } from "react-icons/fa";

export const metadata: Metadata = {
  title: "Unauthorized Access - The Scent",
  description: "You do not have permission to access this page.",
};

export default function UnauthorizedPage() {
  return (
    <div className="container mx-auto flex min-h-[calc(100vh-8rem)] flex-col items-center justify-center px-4 py-12 text-center">
      <FaExclamationTriangle className="mb-6 h-16 w-16 text-destructive" />
      <h1 className="text-4xl font-bold tracking-tight text-foreground sm:text-5xl">
        Access Denied
      </h1>
      <p className="mt-4 text-lg text-muted-foreground">
        Sorry, you do not have the necessary permissions to view this page.
      </p>
      <div className="mt-10 flex items-center justify-center gap-x-6">
        <Button asChild>
          <Link href="/">Go back home</Link>
        </Button>
        <Button variant="link" asChild>
          <Link href="/contact">Contact support <span aria-hidden="true">&rarr;</span></Link>
        </Button>
      </div>
    </div>
  );
}
```

# src/app/layout.tsx
```tsx
// src/app/layout.tsx
import "~/styles/globals.css"; 

import { type ReactNode } from "react";
import { Analytics } from "@vercel/analytics/react";
import { SpeedInsights } from "@vercel/speed-insights/next";
import { headers } from "next/headers"; 

import { cn } from "~/lib/utils"; 
import { Providers } from "./providers"; 
import { Navbar } from "~/components/layout/Navbar"; 
import { Footer } from "~/components/layout/Footer"; 
import { Toaster } from "~/components/ui/Toaster";   
import { env } from "~/env.js"; 

export const metadata = {
  metadataBase: new URL(env.NEXT_PUBLIC_SITE_URL || "http://localhost:3000"),
  title: {
    default: "The Scent — Signature Aromatherapy & Wellness",
    template: "%s — The Scent",
  },
  description: "Discover handcrafted aromatherapy products for wellness and self-care. Experience the transformative power of nature with The Scent.",
  keywords: ["aromatherapy", "wellness", "essential oils", "self-care", "natural products", "mindfulness", "the scent", "relaxation", "meditation"],
  authors: [{ name: "The Scent Team", url: env.NEXT_PUBLIC_SITE_URL }],
  icons: { icon: "/favicon.ico", shortcut: "/favicon.ico", apple: "/apple-touch-icon.png" },
  manifest: "/site.webmanifest",
  openGraph: { type: "website", locale: "en_US", url: env.NEXT_PUBLIC_SITE_URL, siteName: "The Scent", title: { default: "The Scent — Signature Aromatherapy & Wellness", template: "%s — The Scent" }, description: "Discover handcrafted aromatherapy products for wellness and self-care.", images: [ { url: "/images/og-default.jpg", width: 1200, height: 630, alt: "The Scent Collection" } ]},
  twitter: { card: "summary_large_image", title: { default: "The Scent — Signature Aromatherapy & Wellness", template: "%s — The Scent" }, description: "Handcrafted aromatherapy products for wellness, self-care, and mindful living.", images: ["/images/twitter-default.jpg"]},
};

export default function RootLayout({ children }: { children: ReactNode }) {
  const requestHeaders = headers(); 

  return (
    // The `font-body` class will be applied by `html` tag from globals.css
    <html lang="en" suppressHydrationWarning className="scroll-smooth antialiased"> 
      <head>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossOrigin="anonymous" />
        <link 
          href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Montserrat:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&family=Raleway:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap" 
          rel="stylesheet" 
        />
      </head> 
      {/* Body directly uses styles from @layer base in globals.css, including font-family */}
      <body>
        <Providers requestHeaders={requestHeaders}> 
          <div className="relative flex min-h-dvh flex-col"> {/* This div gets bg-background from body */}
            <Navbar />
            {/* Navbar height (h-16 or h-20 from Navbar.tsx) should be accounted for here */}
            <main className="flex-grow pt-16 sm:pt-20"> {/* Updated padding top */}
              {children}
            </main>
            <Footer />
          </div>
          <Toaster /> 
        </Providers>
        <Analytics /> 
        <SpeedInsights /> 
      </body>
    </html>
  );
}
```

# src/app/privacy-policy/page.tsx
```tsx
// src/app/privacy-policy/page.tsx
import { type Metadata } from "next";
import Link from "next/link";

export const metadata: Metadata = {
  title: "Privacy Policy - The Scent",
  description: "Read The Scent's privacy policy to understand how we collect, use, and protect your personal information.",
};

export default function PrivacyPolicyPage() {
  return (
    <div className="container mx-auto min-h-[calc(100vh-theme(space.32))] px-4 py-12 md:py-16">
      <header className="mb-10 text-center">
        <h1 className="text-4xl font-bold tracking-tight text-foreground sm:text-5xl">
          Privacy Policy
        </h1>
        <p className="mt-4 text-lg text-muted-foreground">
          Your privacy is important to us. This policy explains how we handle your personal data.
        </p>
         <p className="text-xs text-muted-foreground mt-2">Last Updated: October 27, 2023</p>
      </header>

      <div className="prose dark:prose-invert max-w-3xl mx-auto space-y-6">
        <section>
          <h2 className="text-xl font-semibold">1. Introduction</h2>
          <p>
            Welcome to The Scent. We are committed to protecting your privacy and ensuring that your personal information is handled in a safe and responsible manner. This Privacy Policy outlines how we collect, use, disclose, and safeguard your information when you visit our website and use our services.
          </p>
        </section>

        <section>
          <h2 className="text-xl font-semibold">2. Information We Collect</h2>
          <p>
            We may collect personal information that you voluntarily provide to us when you register on the website, place an order, subscribe to our newsletter, respond to a survey, fill out a form, or otherwise interact with us. This may include:
          </p>
          <ul>
            <li>Contact Data: Name, email address, postal address, phone number.</li>
            <li>Account Data: Username, password, purchase history.</li>
            <li>Payment Data: Payment card details (processed securely by our payment gateway, Stripe). We do not store full card numbers.</li>
            <li>Usage Data: Information about how you use our website and services, IP address, browser type, operating system.</li>
          </ul>
        </section>

        <section>
          <h2 className="text-xl font-semibold">3. How We Use Your Information</h2>
          <p>
            We use the information we collect in various ways, including to:
          </p>
          <ul>
            <li>Provide, operate, and maintain our website and services.</li>
            <li>Process your transactions and manage your orders.</li>
            <li>Improve, personalize, and expand our website and services.</li>
            <li>Understand and analyze how you use our website.</li>
            <li>Develop new products, services, features, and functionality.</li>
            <li>Communicate with you, either directly or through one of our partners, including for customer service, to provide you with updates and other information relating to the website, and for marketing and promotional purposes (with your consent where required).</li>
            <li>Send you emails.</li>
            <li>Find and prevent fraud.</li>
          </ul>
        </section>
        
        <section>
          <h2 className="text-xl font-semibold">4. Sharing Your Information</h2>
          <p>
            We do not sell, trade, or otherwise transfer to outside parties your Personally Identifiable Information unless we provide users with advance notice. This does not include website hosting partners and other parties who assist us in operating our website, conducting our business, or serving our users, so long as those parties agree to keep this information confidential. We may also release information when it's release is appropriate to comply with the law, enforce our site policies, or protect ours or others' rights, property or safety.
          </p>
        </section>

        <section>
          <h2 className="text-xl font-semibold">5. Data Security</h2>
          <p>
            We implement a variety of security measures to maintain the safety of your personal information when you place an order or enter, submit, or access your personal information. All sensitive/credit information you supply is encrypted via Secure Socket Layer (SSL) technology and processed through a gateway provider and is not stored or processed on our servers.
          </p>
        </section>
        
        <section>
          <h2 className="text-xl font-semibold">6. Your Data Rights</h2>
          <p>
            Depending on your location, you may have certain rights regarding your personal data, such as the right to access, correct, delete, or restrict its processing. To exercise these rights, please <Link href="/contact" className="text-primary hover:underline">contact us</Link>.
          </p>
        </section>

        <section>
          <h2 className="text-xl font-semibold">7. Changes to This Privacy Policy</h2>
          <p>
            We may update this Privacy Policy from time to time. We will notify you of any changes by posting the new Privacy Policy on this page. You are advised to review this Privacy Policy periodically for any changes.
          </p>
        </section>

        <section>
          <h2 className="text-xl font-semibold">8. Contact Us</h2>
          <p>
            If you have any questions about this Privacy Policy, please <Link href="/contact" className="text-primary hover:underline">contact us</Link>.
          </p>
        </section>
      </div>
    </div>
  );
}
```

# src/app/providers.tsx
```tsx
// src/app/providers.tsx
"use client";

import { type ReactNode } from "react";
import { SessionProvider } from "next-auth/react";
import { ThemeProvider as NextThemesProvider } from "next-themes";
import { CartProvider } from "~/contexts/CartContext";
import { WishlistProvider } from "~/contexts/WishlistContext";
import { LocalizationProvider } from "~/contexts/LocalizationContext";
import { NotificationsProvider } from "~/contexts/NotificationsContext";
import { TRPCReactProvider } from "~/trpc/react";
// DO NOT import { headers } from "next/headers" here; it's server-only.

interface ProvidersProps {
  children: ReactNode;
  requestHeaders?: Headers; // Accept headers as a prop
}

export function Providers({ children, requestHeaders }: ProvidersProps) {
  return (
    <SessionProvider>
      <TRPCReactProvider headers={requestHeaders}> {/* Pass headers to TRPCReactProvider */}
        <NextThemesProvider
          attribute="class"
          defaultTheme="system"
          enableSystem
          disableTransitionOnChange
        >
          <LocalizationProvider>
            <CartProvider>
              <WishlistProvider>
                <NotificationsProvider>
                  {children}
                </NotificationsProvider>
              </WishlistProvider>
            </CartProvider>
          </LocalizationProvider>
        </NextThemesProvider>
      </TRPCReactProvider>
    </SessionProvider>
  );
}
```

# src/app/contact/ContactFormClient.tsx
```tsx
// src/app/contact/ContactFormClient.tsx
"use client";

import { useState } from "react";
import { Button } from "~/components/ui/Button";
import { Input } from "~/components/ui/Input";
import { Textarea } from "~/components/ui/Textarea"; // Assuming Textarea UI component
import { Label } from "~/components/ui/Label"; // Assuming Label UI component
import { toast } from "react-hot-toast";
// import { api as clientApi } from "~/trpc/react"; // If submitting via tRPC

export default function ContactForm() {
  const [formData, setFormData] = useState({ name: "", email: "", subject: "", message: "" });
  const [isSubmitting, setIsSubmitting] = useState(false);

  // Placeholder for tRPC mutation
  // const contactMutation = clientApi.messaging.sendContactForm.useMutation({
  //   onSuccess: () => {
  //     toast.success("Your message has been sent! We'll get back to you soon.");
  //     setFormData({ name: "", email: "", subject: "", message: "" });
  //   },
  //   onError: (error) => {
  //     toast.error(error.message || "Failed to send message. Please try again.");
  //   },
  //   onSettled: () => {
  //     setIsSubmitting(false);
  //   }
  // });

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
  };

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    setIsSubmitting(true);
    // contactMutation.mutate(formData);
    // Placeholder logic:
    await new Promise(res => setTimeout(res, 1000));
    console.log("Contact form submitted:", formData);
    toast.success("Message sent (placeholder)! We'll get back to you soon.");
    setFormData({ name: "", email: "", subject: "", message: "" });
    setIsSubmitting(false);
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div>
        <Label htmlFor="name">Full Name</Label>
        <Input type="text" name="name" id="name" value={formData.name} onChange={handleChange} required disabled={isSubmitting} />
      </div>
      <div>
        <Label htmlFor="email">Email Address</Label>
        <Input type="email" name="email" id="email" value={formData.email} onChange={handleChange} required disabled={isSubmitting} />
      </div>
      <div>
        <Label htmlFor="subject">Subject</Label>
        <Input type="text" name="subject" id="subject" value={formData.subject} onChange={handleChange} required disabled={isSubmitting} />
      </div>
      <div>
        <Label htmlFor="message">Message</Label>
        <Textarea name="message" id="message" rows={5} value={formData.message} onChange={handleChange} required disabled={isSubmitting} />
      </div>
      <div>
        <Button type="submit" className="w-full" isLoading={isSubmitting} loadingText="Sending...">
          Send Message
        </Button>
      </div>
    </form>
  );
}
```

# src/app/contact/page.tsx
```tsx
// src/app/contact/page.tsx
import { type Metadata } from "next";
import ContactForm from "./ContactFormClient"; // Client component for the form

export const metadata: Metadata = {
  title: "Contact Us - The Scent",
  description: "Get in touch with The Scent customer support team. We're here to help with your inquiries.",
};

export default function ContactPage() {
  return (
    <div className="container mx-auto px-4 py-12 md:py-16">
      <div className="max-w-3xl mx-auto">
        <div className="text-center mb-10">
          <h1 className="text-4xl font-bold tracking-tight text-foreground sm:text-5xl">Get In Touch</h1>
          <p className="mt-4 text-lg text-muted-foreground">
            We'd love to hear from you! Whether you have a question about our products, an order, or just want to share your scent story, reach out to us.
          </p>
        </div>

        <div className="grid md:grid-cols-2 gap-10 lg:gap-16 items-start">
          {/* Contact Information */}
          <div className="space-y-6">
            <div>
              <h2 className="text-xl font-semibold text-foreground mb-2">Our Office</h2>
              <p className="text-muted-foreground">
                123 Aroma Lane<br />
                Wellness City, SC 12345<br />
                United States
              </p>
              {/* <p className="text-sm text-muted-foreground mt-1">(Visits by appointment only)</p> */}
            </div>
            <div>
              <h2 className="text-xl font-semibold text-foreground mb-2">Email Us</h2>
              <a href="mailto:support@thescent.example.com" className="text-primary hover:underline">
                support@thescent.example.com
              </a>
              <p className="text-sm text-muted-foreground mt-1">We typically respond within 24 hours.</p>
            </div>
            <div>
              <h2 className="text-xl font-semibold text-foreground mb-2">Call Us</h2>
              <a href="tel:+18005550199" className="text-primary hover:underline">
                +1 (800) 555-0199
              </a>
              <p className="text-sm text-muted-foreground mt-1">Mon - Fri, 9am - 5pm EST</p>
            </div>
            {/* Optional: Social Media Links */}
          </div>

          {/* Contact Form */}
          <div>
            <h2 className="text-xl font-semibold text-foreground mb-4">Send Us a Message</h2>
            <ContactForm />
          </div>
        </div>
      </div>
    </div>
  );
}
```

# src/app/shipping-returns/page.tsx
```tsx
// src/app/shipping-returns/page.tsx
import { type Metadata } from "next";
import Link from "next/link";

export const metadata: Metadata = {
  title: "Shipping & Returns - The Scent",
  description: "Information about our shipping policies, delivery times, and returns process for The Scent products.",
};

export default function ShippingReturnsPage() {
  return (
    <div className="container mx-auto min-h-[calc(100vh-theme(space.32))] px-4 py-12 md:py-16"> {/* Adjust min-h for navbar/footer height */}
      <header className="mb-10 text-center">
        <h1 className="text-4xl font-bold tracking-tight text-foreground sm:text-5xl">
          Shipping & Returns
        </h1>
        <p className="mt-4 text-lg text-muted-foreground">
          Everything you need to know about how we get our scents to you, and what to do if things aren't perfect.
        </p>
      </header>

      <div className="prose dark:prose-invert max-w-3xl mx-auto space-y-8">
        <section>
          <h2 className="text-2xl font-semibold">Shipping Policy</h2>
          <p>
            We are committed to delivering your aromatherapy products swiftly and safely. All orders are processed within 1-2 business days. You will receive a notification once your order has shipped.
          </p>
          <h3>Shipping Rates & Delivery Times:</h3>
          <ul>
            <li><strong>Standard Shipping (3-5 business days):</strong> $5.99 (Free for orders over $50)</li>
            <li><strong>Express Shipping (1-2 business days):</strong> $12.99</li>
            <li><strong>International Shipping:</strong> Rates and times vary by destination. Please proceed to checkout to see options for your country.</li>
          </ul>
          <p>
            Please note that delivery times are estimates and may vary due to carrier delays or unforeseen circumstances.
          </p>
        </section>

        <section>
          <h2 className="text-2xl font-semibold">Returns & Exchanges</h2>
          <p>
            Your satisfaction is our priority. If you're not completely happy with your purchase, we're here to help.
          </p>
          <h3>Our Guarantee:</h3>
          <p>
            We accept returns for most items within 30 days of receipt, provided they are unused and in their original packaging. Due to the nature of our products, some items like opened essential oils may not be eligible for return unless defective.
          </p>
          <h3>How to Initiate a Return:</h3>
          <ol>
            <li>Contact our support team at <Link href="mailto:support@thescent.example.com" className="text-primary hover:underline">support@thescent.example.com</Link> with your order number and reason for return.</li>
            <li>Our team will provide you with a return authorization and shipping instructions.</li>
            <li>Once we receive and inspect your returned item(s), we will process your refund or exchange.</li>
          </ol>
          <p>
            Customers are typically responsible for return shipping costs unless the item is defective or an error occurred on our part.
          </p>
        </section>

        <section>
          <h2 className="text-2xl font-semibold">Damaged or Incorrect Items</h2>
          <p>
            If you receive a damaged or incorrect item, please contact us immediately (within 7 days of receipt) with photos of the issue. We will arrange for a replacement or refund at no additional cost to you.
          </p>
        </section>
        
        <p className="text-center text-sm">
            For any further questions, please don't hesitate to <Link href="/contact" className="text-primary hover:underline">contact us</Link>.
        </p>
      </div>
    </div>
  );
}
```

# src/app/terms-of-service/page.tsx
```tsx
// src/app/terms-of-service/page.tsx
import { type Metadata } from "next";
import Link from "next/link";

export const metadata: Metadata = {
  title: "Terms of Service - The Scent",
  description: "Read the Terms of Service for using The Scent website and purchasing our products.",
};

export default function TermsOfServicePage() {
  return (
    <div className="container mx-auto min-h-[calc(100vh-theme(space.32))] px-4 py-12 md:py-16">
      <header className="mb-10 text-center">
        <h1 className="text-4xl font-bold tracking-tight text-foreground sm:text-5xl">
          Terms of Service
        </h1>
        <p className="mt-4 text-lg text-muted-foreground">
          Please read these terms carefully before using our services.
        </p>
        <p className="text-xs text-muted-foreground mt-2">Last Updated: October 27, 2023</p>
      </header>

      <div className="prose dark:prose-invert max-w-3xl mx-auto space-y-6">
        <section>
          <h2 className="text-xl font-semibold">1. Agreement to Terms</h2>
          <p>
            By accessing or using our website and services, you agree to be bound by these Terms of Service and our <Link href="/privacy-policy" className="text-primary hover:underline">Privacy Policy</Link>. If you do not agree to all the terms and conditions, then you may not access the website or use any services.
          </p>
        </section>

        <section>
          <h2 className="text-xl font-semibold">2. Use of Our Service</h2>
          <p>
            The Scent grants you a limited, non-exclusive, non-transferable, and revocable license to use our service for your personal, non-commercial use, subject to these Terms. You agree not to reproduce, duplicate, copy, sell, resell or exploit any portion of the Service, use of the Service, or access to the Service without express written permission by us.
          </p>
        </section>
        
        <section>
          <h2 className="text-xl font-semibold">3. Products or Services</h2>
          <p>
            Certain products or services may be available exclusively online through the website. These products or services may have limited quantities and are subject to return or exchange only according to our <Link href="/shipping-returns" className="text-primary hover:underline">Return Policy</Link>. We have made every effort to display as accurately as possible the colors and images of our products. We cannot guarantee that your computer monitor's display of any color will be accurate.
          </p>
        </section>

        <section>
          <h2 className="text-xl font-semibold">4. Accuracy of Billing and Account Information</h2>
          <p>
            We reserve the right to refuse any order you place with us. We may, in our sole discretion, limit or cancel quantities purchased per person, per household or per order. You agree to provide current, complete and accurate purchase and account information for all purchases made at our store.
          </p>
        </section>
        
        <section>
          <h2 className="text-xl font-semibold">5. Intellectual Property</h2>
          <p>
            The Service and its original content, features and functionality are and will remain the exclusive property of The Scent and its licensors.
          </p>
        </section>

        <section>
          <h2 className="text-xl font-semibold">6. Limitation of Liability</h2>
          <p>
            In no case shall The Scent, our directors, officers, employees, affiliates, agents, contractors, interns, suppliers, service providers or licensors be liable for any injury, loss, claim, or any direct, indirect, incidental, punitive, special, or consequential damages of any kind... (Standard legal boilerplate).
          </p>
        </section>
        
        <section>
          <h2 className="text-xl font-semibold">7. Governing Law</h2>
          <p>
            These Terms of Service and any separate agreements whereby we provide you Services shall be governed by and construed in accordance with the laws of [Your State/Country].
          </p>
        </section>

        <section>
          <h2 className="text-xl font-semibold">8. Changes to Terms of Service</h2>
          <p>
            You can review the most current version of the Terms of Service at any time at this page. We reserve the right, at our sole discretion, to update, change or replace any part of these Terms of Service by posting updates and changes to our website.
          </p>
        </section>
        
        <section>
          <h2 className="text-xl font-semibold">9. Contact Information</h2>
          <p>
            Questions about the Terms of Service should be sent to us at <Link href="mailto:legal@thescent.example.com" className="text-primary hover:underline">legal@thescent.example.com</Link> or through our <Link href="/contact" className="text-primary hover:underline">contact page</Link>.
          </p>
        </section>
      </div>
    </div>
  );
}
```

# src/app/products/[slug]/page.tsx
```tsx
// src/app/products/[slug]/page.tsx
import { type Metadata } from "next";
import Head from "next/head"; // Can still be used for dynamic updates in client components if needed
import Image from "next/image";
import Link from "next/link";

import { db } from "~/server/db"; // Direct DB access for server component data fetching
import { api as serverApi } from "~/trpc/server"; // Server-side tRPC caller
import ProductClientInteractions from "./ProductClientInteractions"; // New client component
import { ProductReviews } from "~/components/products/ProductReviews"; // Assumed to handle its own data or be client
import { RecommendedProducts } from "~/components/products/RecommendedProducts"; // Assumed to handle its own data or be client
import { ARVisualization } from "~/components/products/ARVisualization"; // This is likely a client component
import { Breadcrumbs } from "~/components/ui/Breadcrumbs"; // Placeholder UI component
import { notFound } from "next/navigation"; // For 404 in App Router
import { env } from "~/env.mjs";
import { type ProductWithRelations } from "~/types/product"; // Define this type centrally


// Define the expected params structure
interface ProductDetailPageProps {
  params: { slug: string };
}

// generateMetadata for SEO (App Router convention)
export async function generateMetadata({ params }: ProductDetailPageProps): Promise<Metadata> {
  try {
    const product = await db.product.findUnique({
      where: { slug: params.slug, publishedAt: { not: null, lte: new Date() } },
      select: {
        name: true,
        description: true,
        metaTitle: true,
        metaDescription: true,
        images: { select: { url: true, altText: true }, take: 1, orderBy: { position: "asc" } },
      },
    });

    if (!product) {
      return {
        title: "Product Not Found",
        description: "The product you are looking for does not exist or is not available.",
      };
    }

    const title = product.metaTitle || product.name;
    const description = product.metaDescription || product.description.substring(0, 160);
    const imageUrl = product.images[0]?.url 
        ? (product.images[0].url.startsWith('http') ? product.images[0].url : `${env.NEXT_PUBLIC_SITE_URL}${product.images[0].url}`)
        : `${env.NEXT_PUBLIC_SITE_URL}/images/og-image.jpg`;


    return {
      title: title,
      description: description,
      openGraph: {
        title: title,
        description: description,
        type: "product",
        url: `${env.NEXT_PUBLIC_SITE_URL}/products/${params.slug}`,
        images: [{ url: imageUrl, alt: product.images[0]?.altText || title }],
        // OpenGraph product specific fields can be added here
      },
      twitter: {
        card: "summary_large_image",
        title: title,
        description: description,
        images: [imageUrl],
      },
    };
  } catch (error) {
    console.error("Error generating metadata for product:", params.slug, error);
    return {
      title: "Error",
      description: "Could not load product information.",
    };
  }
}

// Server Component to fetch initial product data
export default async function ProductDetailPage({ params }: ProductDetailPageProps) {
  const { slug } = params;

  // Fetch product data server-side
  const productData = await db.product.findUnique({
    where: { slug: slug, publishedAt: { not: null, lte: new Date() } },
    include: {
      images: { orderBy: { position: 'asc' } },
      variants: { orderBy: [{ isDefault: 'desc' }, { name: 'asc' }] },
      categories: { select: { id: true, name: true, slug: true } }, // Select only needed fields
      tags: { select: { id: true, name: true, slug: true } },
      reviews: {
        orderBy: { createdAt: 'desc' },
        take: 5, // Initial load, more can be fetched client-side
        include: { user: { select: { id: true, name: true, image: true } } },
      },
    },
  });

  if (!productData) {
    notFound(); // Triggers the not-found.tsx page in App Router
  }

  // Process data for client (convert Decimals, Dates)
  const totalRating = productData.reviews.reduce((sum, review) => sum + review.rating, 0);
  const reviewCount = productData.reviews.length;
  const avgRating = reviewCount > 0 ? totalRating / reviewCount : 0;

  const product: ProductWithRelations = {
    ...productData,
    price: parseFloat(productData.price.toString()),
    compareAtPrice: productData.compareAtPrice ? parseFloat(productData.compareAtPrice.toString()) : null,
    costPrice: productData.costPrice ? parseFloat(productData.costPrice.toString()) : null, // Not used directly on page but good to have
    createdAt: productData.createdAt.toISOString(),
    updatedAt: productData.updatedAt.toISOString(),
    publishedAt: productData.publishedAt?.toISOString() || null,
    saleEndDate: productData.saleEndDate?.toISOString() || null,
    variants: productData.variants.map(v => ({
      ...v,
      price: v.price ? parseFloat(v.price.toString()) : null,
      stockQuantity: v.stockQuantity ?? 0,
    })),
    reviews: productData.reviews.map(r => ({
      ...r,
      createdAt: r.createdAt.toISOString(),
      updatedAt: r.updatedAt.toISOString(),
    })),
    avgRating,
    reviewCount,
  };

  const breadcrumbItems = [
    { name: "Home", href: "/" },
    { name: "Products", href: "/products" },
    ...(product.categories[0] ? [{ name: product.categories[0].name, href: `/categories/${product.categories[0].slug}` }] : []),
    { name: product.name, href: `/products/${product.slug}`, isCurrent: true },
  ];

  return (
    <div className="container mx-auto px-4 py-8">
      <Breadcrumbs items={breadcrumbItems} />
      
      <div className="grid grid-cols-1 gap-8 lg:grid-cols-2 mt-6">
        {/* ProductClientInteractions will handle gallery, variant selection, add to cart etc. */}
        <ProductClientInteractions product={product} />
      </div>
      
      {/* AR Visualization - needs to be a Client Component */}
      {product.modelUrl && (
        <div className="my-12 rounded-lg border border-border bg-card p-4 md:p-6 shadow-sm">
           <h2 className="text-xl font-semibold text-foreground mb-4">Visualize in Your Space</h2>
          <ARVisualization
            productId={product.id}
            productName={product.name}
            modelUrl={product.modelUrl}
            previewImageUrl={product.images[0]?.url}
            productSize={product.dimensions as {width:number, height:number, depth:number} | undefined}
          />
        </div>
      )}
      
      {/* Reviews Section - ProductReviews component will handle fetching more reviews if needed */}
      <div id="reviews" className="mt-16">
        <h2 className="mb-8 text-2xl font-bold text-gray-900 dark:text-white">
          Customer Reviews
        </h2>
        <ProductReviews 
          productId={product.id} 
          productName={product.name} 
          initialReviews={product.reviews} 
          avgRating={product.avgRating} 
          reviewCount={product.reviewCount}
        />
      </div>
      
      {/* Recommended Products - RecommendedProducts component handles its own data fetching */}
      <div className="mt-16">
        <h2 className="mb-8 text-2xl font-bold text-gray-900 dark:text-white">
          You May Also Like
        </h2>
        <RecommendedProducts 
          productId={product.id} 
          categoryIds={product.categories.map(c => c.id)}
        />
      </div>
    </div>
  );
}
```

# src/app/products/[slug]/ProductClientInteractions.tsx
```tsx
// src/app/products/[slug]/ProductClientInteractions.tsx
"use client";

import { useState, useEffect, useMemo } from "react";
import { useRouter } from "next/navigation"; // Use next/navigation for App Router
import Image from "next/image";
import { useCart } from "~/contexts/CartContext";
import { useWishlist } from "~/contexts/WishlistContext";
import { Button } from "~/components/ui/Button";
import { ProductGallery } from "~/components/products/ProductGallery";
import { Rating } from "~/components/ui/Rating";
import { Tabs, TabsList, TabsTrigger, TabsContent } from "~/components/ui/Tabs";
import { Label } from "~/components/ui/Label";
import { 
  FaHeart, FaRegHeart, FaShoppingCart, FaTruck, FaLeaf, FaRecycle, FaRegClock, FaInfoCircle, FaCheck, FaTimes
} from "react-icons/fa";
import { toast } from "react-hot-toast";
import { formatCurrency } from "~/utils/format";
import type { ProductWithRelations, ProcessedProductVariant } from "~/types/product"; // Assuming these types are defined

interface ProductClientInteractionsProps {
  product: ProductWithRelations;
}

export default function ProductClientInteractions({ product }: ProductClientInteractionsProps) {
  const router = useRouter();
  const { addItem: addItemToCart } = useCart();
  const { addToWishlist, removeFromWishlist, isInWishlist } = useWishlist();

  const [selectedVariant, setSelectedVariant] = useState<ProcessedProductVariant | null>(null);
  const [quantity, setQuantity] = useState(1);
  const [activeImageIndex, setActiveImageIndex] = useState(0);
  const [saleRemainingTime, setSaleRemainingTime] = useState<string | null>(null);

  useEffect(() => {
    if (product.variants && product.variants.length > 0) {
      const defaultVariant = product.variants.find(v => v.isDefault) || product.variants[0];
      setSelectedVariant(defaultVariant ?? null);
    } else {
        setSelectedVariant(null);
    }
  }, [product.variants]);

  useEffect(() => {
    if (!product.onSale || !product.saleEndDate) {
      setSaleRemainingTime(null);
      return;
    }
    const saleEndDateObj = new Date(product.saleEndDate);
    if (isNaN(saleEndDateObj.getTime())) {
        setSaleRemainingTime(null);
        return;
    }
    const intervalId = setInterval(() => {
      const now = new Date();
      const diffMs = saleEndDateObj.getTime() - now.getTime();
      if (diffMs <= 0) {
        setSaleRemainingTime("Sale ended");
        clearInterval(intervalId);
        return;
      }
      const d = Math.floor(diffMs/(1000*60*60*24));
      const h = Math.floor((diffMs/(1000*60*60)) % 24);
      const m = Math.floor((diffMs/1000/60) % 60);
      const s = Math.floor((diffMs/1000) % 60);
      setSaleRemainingTime(`${d}d ${h}h ${m}m ${s}s`);
    }, 1000);
    return () => clearInterval(intervalId);
  }, [product.onSale, product.saleEndDate]);

  const currentPrice = useMemo(() => {
    return selectedVariant?.price ?? product.price;
  }, [selectedVariant, product.price]);

  const originalPrice = useMemo(() => {
    return product.compareAtPrice;
  }, [product.compareAtPrice]);

  const discountPercentage = useMemo(() => {
    if (originalPrice && currentPrice < originalPrice) {
      return Math.round(((originalPrice - currentPrice) / originalPrice) * 100);
    }
    return 0;
  }, [originalPrice, currentPrice]);

  const isInStock = useMemo(() => {
    if (selectedVariant) {
      return selectedVariant.stockQuantity === null || selectedVariant.stockQuantity > 0;
    }
    return product.inStock && (product.stockQuantity === null || product.stockQuantity > 0);
  }, [product.inStock, product.stockQuantity, selectedVariant]);

  const handleAddToCart = () => {
    if (!isInStock) {
      toast.error("This product is currently out of stock.");
      return;
    }
    addItemToCart({
      id: product.id,
      variantId: selectedVariant?.id,
      name: product.name + (selectedVariant ? ` - ${selectedVariant.name}` : ""),
      price: currentPrice,
      imageUrl: selectedVariant?.imageUrl ?? product.images[0]?.url ?? "",
      quantity: quantity,
      slug: product.slug,
      variantName: selectedVariant?.name,
    });
  };

  const handleToggleWishlist = () => {
     const wishlistItem = {
        id: product.id,
        variantId: selectedVariant?.id,
        name: product.name + (selectedVariant ? ` - ${selectedVariant.name}` : ""),
        price: currentPrice,
        imageUrl: selectedVariant?.imageUrl ?? product.images[0]?.url ?? "",
        slug: product.slug,
    };
    if (isInWishlist(product.id, selectedVariant?.id)) {
      removeFromWishlist(product.id, selectedVariant?.id);
      toast.success(`${wishlistItem.name} removed from wishlist`);
    } else {
      addToWishlist(wishlistItem);
      toast.success(`${wishlistItem.name} added to wishlist`);
    }
  };

  return (
    <>
      {/* Product Gallery */}
      <div className="lg:sticky lg:top-24 self-start">
        <ProductGallery 
          images={product.images} 
          productName={product.name} 
          activeIndex={activeImageIndex}
          setActiveIndex={setActiveImageIndex}
          currentVariantImageUrl={selectedVariant?.imageUrl}
        />
      </div>
      
      {/* Product Details */}
      <div className="flex flex-col">
        <h1 className="mb-2 text-3xl font-bold tracking-tight text-gray-900 dark:text-white sm:text-4xl">
          {product.name}
        </h1>
        
        <div className="mb-4 flex items-center">
          <Rating value={product.avgRating} readOnly size="md" />
          <a href="#reviews" className="ml-3 text-sm font-medium text-primary hover:text-primary-dark dark:text-primary-light dark:hover:text-primary">
            {product.reviewCount} {product.reviewCount === 1 ? 'review' : 'reviews'}
          </a>
        </div>
        
        <div className="mb-6 flex items-baseline gap-2">
          <span className="text-3xl font-bold text-gray-900 dark:text-white">
            {formatCurrency(currentPrice)}
          </span>
          {originalPrice && originalPrice > currentPrice && (
            <span className="text-xl text-gray-500 line-through dark:text-gray-400">
              {formatCurrency(originalPrice)}
            </span>
          )}
          {discountPercentage > 0 && (
            <span className="rounded-md bg-red-100 px-2 py-1 text-sm font-semibold text-red-700 dark:bg-red-900/30 dark:text-red-300">
              SAVE {discountPercentage}%
            </span>
          )}
        </div>
        
        {product.onSale && saleRemainingTime && saleRemainingTime !== "Sale ended" && (
          <div className="mb-4 flex items-center rounded-md bg-amber-100 p-3 dark:bg-amber-900/30">
            <FaRegClock className="mr-2 h-5 w-5 text-amber-600 dark:text-amber-400" />
            <span className="text-sm font-medium text-amber-800 dark:text-amber-200">
              Sale ends in: {saleRemainingTime}
            </span>
          </div>
        )}
        {product.onSale && saleRemainingTime === "Sale ended" && (
          <div className="mb-4 rounded-md bg-gray-100 p-3 text-sm font-medium text-gray-700 dark:bg-gray-800 dark:text-gray-300">
            Sale has ended.
          </div>
        )}

        <div className="mb-6 prose prose-sm max-w-none text-gray-700 dark:prose-invert dark:text-gray-300">
          <p>{product.description.split('\n\n')[0]}</p>
        </div>
        
        {product.variants.length > 0 && (
          <div className="mb-6">
            <h3 className="mb-2 text-sm font-semibold text-gray-700 dark:text-gray-300">
              Options: {selectedVariant?.name || "Select an option"}
            </h3>
            <div className="flex flex-wrap gap-2">
              {product.variants.map((variant) => (
                <Button
                  key={variant.id}
                  variant={selectedVariant?.id === variant.id ? "default" : "outline"}
                  onClick={() => setSelectedVariant(variant)}
                  disabled={(variant.stockQuantity ?? 0) <= 0}
                  className={`relative transition-all ${ (variant.stockQuantity ?? 0) <= 0 ? "cursor-not-allowed opacity-50" : ""}`}
                >
                  {variant.name}
                  {(variant.stockQuantity ?? 0) <= 0 && (
                    <span className="absolute -top-1 -right-1 block h-2.5 w-2.5 rounded-full bg-red-500 ring-2 ring-white dark:ring-gray-900"></span>
                  )}
                </Button>
              ))}
            </div>
          </div>
        )}
        
        <div className="mb-6 text-sm">
            {isInStock ? (
                <span className="inline-flex items-center gap-1 font-medium text-green-600 dark:text-green-400">
                    <FaCheck /> In Stock {selectedVariant && selectedVariant.stockQuantity !== null ? `(${selectedVariant.stockQuantity} left)` : product.stockQuantity !== null ? `(${product.stockQuantity} left)` : ''}
                </span>
            ) : (
                <span className="inline-flex items-center gap-1 font-medium text-red-600 dark:text-red-400">
                    <FaTimes /> Out of Stock
                </span>
            )}
             {product.sku && <span className="ml-4 text-gray-500 dark:text-gray-400">SKU: {selectedVariant?.sku || product.sku}</span>}
        </div>

        <div className="mb-6">
          <Label htmlFor="quantity-pdp" className="mb-2 block text-sm font-semibold text-gray-700 dark:text-gray-300">
            Quantity
          </Label>
          <div className="flex h-10 w-32 items-center rounded-md border border-border">
            <Button variant="ghost" size="icon" className="h-full rounded-r-none" onClick={() => setQuantity(Math.max(1, quantity - 1))} disabled={quantity <= 1}>-</Button>
            <input
              id="quantity-pdp"
              type="number"
              min="1"
              value={quantity}
              onChange={(e) => setQuantity(Math.max(1, parseInt(e.target.value) || 1))}
              className="h-full w-full border-0 bg-transparent text-center text-foreground focus:outline-none focus:ring-0"
            />
            <Button variant="ghost" size="icon" className="h-full rounded-l-none" onClick={() => setQuantity(quantity + 1)} disabled={!isInStock}>+</Button>
          </div>
        </div>
        
        <div className="mb-8 flex flex-col gap-4 sm:flex-row">
          <Button onClick={handleAddToCart} disabled={!isInStock} size="lg" className="flex-1 sm:flex-auto">
            <FaShoppingCart className="mr-2 h-5 w-5" />
            {isInStock ? 'Add to Cart' : 'Out of Stock'}
          </Button>
          <Button onClick={handleToggleWishlist} variant="outline" size="lg" className="flex-1 sm:flex-auto">
            {isInWishlist(product.id, selectedVariant?.id) ? (
              <FaHeart className="mr-2 h-5 w-5 text-red-500" />
            ) : (
              <FaRegHeart className="mr-2 h-5 w-5" />
            )}
            {isInWishlist(product.id, selectedVariant?.id) ? 'In Wishlist' : 'Add to Wishlist'}
          </Button>
        </div>
        
        <div className="mb-6">
          <Tabs defaultValue="description">
            <TabsList className="grid w-full grid-cols-3">
              <TabsTrigger value="description">Description</TabsTrigger>
              <TabsTrigger value="details">Details</TabsTrigger>
              <TabsTrigger value="shipping">Shipping & Returns</TabsTrigger>
            </TabsList>
            <TabsContent value="description" className="prose prose-sm dark:prose-invert mt-4 max-w-none">
              <div dangerouslySetInnerHTML={{ __html: product.description.replace(/\n/g, '<br />') }} />
            </TabsContent>
            <TabsContent value="details" className="mt-4 text-sm text-gray-700 dark:text-gray-300 space-y-2">
              <p><FaLeaf className="mr-2 inline-block text-green-500" />100% Natural Essential Oils</p>
              <p><FaRecycle className="mr-2 inline-block text-blue-500" />Ethically Sourced Ingredients</p>
              {product.weight && <p>Weight: {product.weight}g</p>}
              {product.dimensions && <p>Dimensions: {(product.dimensions as any).length}x{(product.dimensions as any).width}x{(product.dimensions as any).height} cm</p>}
            </TabsContent>
            <TabsContent value="shipping" className="mt-4 text-sm text-gray-700 dark:text-gray-300 space-y-2">
              <p><FaTruck className="mr-2 inline-block text-primary" />Standard shipping: 3-5 business days.</p>
              <p><FaInfoCircle className="mr-2 inline-block text-gray-500" />Free shipping on orders over $50.</p>
              <p>Easy 30-day returns.</p>
            </TabsContent>
          </Tabs>
        </div>
            
        {product.tags.length > 0 && (
          <div className="mb-6">
            <h3 className="mb-2 text-sm font-semibold text-gray-700 dark:text-gray-300">
              Scent Tags:
            </h3>
            <div className="flex flex-wrap gap-2">
              {product.tags.map((tag) => (
                <Button key={tag.id} variant="outline" size="sm" asChild>
                  <Link href={`/tags/${tag.slug}`}>{tag.name}</Link>
                </Button>
              ))}
            </div>
          </div>
        )}
      </div>
    </>
  );
}
```

# src/app/products/page.tsx
```tsx
// src/app/products/page.tsx
import { type Metadata } from "next";
import Link from "next/link";
import { ProductGrid } from "~/components/products/ProductGrid";
import { createServerActionClient } from "~/trpc/server";

export const metadata: Metadata = {
  title: "All Products - The Scent",
  description: "Browse our entire collection of premium aromatherapy and wellness products.",
};

interface ProductsPageProps {
  searchParams?: {
    page?: string;
    sortBy?: string;
    category?: string;
  };
}

export default async function ProductsPage({ searchParams }: ProductsPageProps) {
  const pageParam = searchParams?.page;
  const sortByParam = searchParams?.sortBy;
  const categoryParam = searchParams?.category;

  // currentPage is not directly used in the `getAll` call yet, but parsed for potential future use.
  // const currentPage = parseInt(pageParam || "1"); 
  const limit = 12; 

  const serverApi = await createServerActionClient();

  let productsData;
  try {
    productsData = await serverApi.products.getAll({
      limit,
      // cursor: If implementing cursor pagination, this would be derived from pageParam or another cursor value.
      categoryId: categoryParam,
      sortBy: sortByParam as any, // Cast if your tRPC router's sortBy enum is specific and different from string.
    });
  } catch (error) {
    console.error("Error fetching products for ProductsPage:", error);
    productsData = { items: [], nextCursor: undefined };
  }

  return (
    <div className="container mx-auto px-4 py-8 md:py-12">
      <div className="mb-8 md:mb-10 text-center">
        <h1 className="text-4xl font-bold tracking-tight text-foreground sm:text-5xl font-head">Our Collection</h1>
        <p className="mt-4 text-lg text-muted-foreground max-w-2xl mx-auto font-body">
          Explore a wide range of natural products designed for your well-being and sensory delight.
        </p>
      </div>

      <div className="grid grid-cols-1 gap-8 lg:grid-cols-4">
        <aside className="lg:col-span-1 lg:sticky lg:top-24 self-start">
          <div className="rounded-lg border border-border bg-card p-6 shadow-sm">
            <h2 className="text-xl font-semibold text-foreground font-head mb-4">Filter & Sort</h2>
            <div className="space-y-6">
              <div>
                <h3 className="text-sm font-medium text-foreground mb-2 font-accent uppercase tracking-wider">Categories</h3>
                <ul className="space-y-1.5 text-sm">
                    <li><Link href={`/products?category=essential-oils${sortByParam ? `&sortBy=${sortByParam}` : ''}`} className="text-muted-foreground hover:text-primary transition-colors">Essential Oils</Link></li>
                    <li><Link href={`/products?category=diffusers${sortByParam ? `&sortBy=${sortByParam}` : ''}`} className="text-muted-foreground hover:text-primary transition-colors">Diffusers</Link></li>
                    <li><Link href={`/products?category=candles${sortByParam ? `&sortBy=${sortByParam}` : ''}`} className="text-muted-foreground hover:text-primary transition-colors">Candles</Link></li>
                    <li><Link href={`/products?category=blends${sortByParam ? `&sortBy=${sortByParam}` : ''}`} className="text-muted-foreground hover:text-primary transition-colors">Signature Blends</Link></li>
                    <li><Link href={`/products${sortByParam ? `?sortBy=${sortByParam}` : ''}`} className="text-muted-foreground hover:text-primary transition-colors font-semibold">All Categories</Link></li>
                </ul>
              </div>
              <div>
                <h3 className="text-sm font-medium text-foreground mb-2 font-accent uppercase tracking-wider">Sort By</h3>
                <ul className="space-y-1.5 text-sm">
                    <li><Link href={`/products?sortBy=createdAt_desc${categoryParam ? `&category=${categoryParam}` : ''}`} className="text-muted-foreground hover:text-primary transition-colors">Newest</Link></li>
                    <li><Link href={`/products?sortBy=price_asc${categoryParam ? `&category=${categoryParam}` : ''}`} className="text-muted-foreground hover:text-primary transition-colors">Price: Low to High</Link></li>
                    <li><Link href={`/products?sortBy=price_desc${categoryParam ? `&category=${categoryParam}` : ''}`} className="text-muted-foreground hover:text-primary transition-colors">Price: High to Low</Link></li>
                    <li><Link href={`/products?sortBy=rating_desc${categoryParam ? `&category=${categoryParam}` : ''}`} className="text-muted-foreground hover:text-primary transition-colors">Rating</Link></li>
                    <li><Link href={`/products${categoryParam ? `?category=${categoryParam}` : ''}`} className="text-muted-foreground hover:text-primary transition-colors font-semibold">Default</Link></li>
                </ul>
              </div>
            </div>
          </div>
        </aside>

        <main className="lg:col-span-3">
          {productsData.items.length > 0 ? (
            <ProductGrid products={productsData.items} />
          ) : (
            <div className="py-16 text-center">
              <p className="text-xl text-muted-foreground">
                No products found. Try adjusting your filters!
              </p>
            </div>
          )}
          {/* TODO: Implement full pagination based on productsData.nextCursor or total count */}
        </main>
      </div>
    </div>
  );
}
```

# src/app/auth/signin/page.tsx
```tsx
// src/app/auth/signin/page.tsx
import { type Metadata } from "next";
import Link from "next/link"; 
import SignInFormClient from "./SignInFormClient"; 

export const metadata: Metadata = {
  title: "Sign In - The Scent",
  description: "Sign in to your The Scent account.",
};

interface SignInPageProps {
  searchParams?: {
    callbackUrl?: string;
    error?: string; 
  };
}

export default async function SignInPage({ searchParams }: SignInPageProps) {
  // Access searchParams properties at the beginning of the function
  const error = searchParams?.error;
  const callbackUrl = searchParams?.callbackUrl;

  return (
    <div className="flex min-h-[calc(100vh-8rem)] items-center justify-center bg-muted/30 px-4 py-12 sm:px-6 lg:px-8 dark:bg-background">
      <div className="w-full max-w-md space-y-8">
        <div>
          <Link href="/" className="flex justify-center mb-6">
            <span className="text-2xl font-bold text-foreground">The Scent</span>
          </Link>
          <h2 className="text-center text-3xl font-bold tracking-tight text-foreground">
            Sign in to your account
          </h2>
          <p className="mt-2 text-center text-sm text-muted-foreground">
            Or{' '}
            <Link href="/auth/signup" className="font-medium text-primary hover:text-primary/80">
              create a new account
            </Link>
          </p>
        </div>
        <SignInFormClient error={error} callbackUrl={callbackUrl} />
      </div>
    </div>
  );
}
```

# src/app/auth/signin/SignInFormClient.tsx
```tsx
// src/app/auth/signin/SignInFormClient.tsx
"use client";
import { signIn, getProviders } from "next-auth/react";
import { useRouter, useSearchParams } from "next/navigation";
import { useState, useEffect } from "react";
import { Button } from "~/components/ui/Button";
import { Input } from "~/components/ui/Input";
import { Label } from "~/components/ui/Label";
import { FaGoogle, FaEnvelope, FaLock } from "react-icons/fa";
import { toast } from "react-hot-toast";

interface Provider {
  id: string;
  name: string;
  type: string;
}

interface SignInFormClientProps {
  error?: string;
  callbackUrl?: string;
}

export default function SignInFormClient({ error: initialError, callbackUrl }: SignInFormClientProps) {
  const router = useRouter();
  const searchParams = useSearchParams(); // Alternative way to get error/callbackUrl client-side
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [isLoading, setIsLoading] = useState(false);
  const [authError, setAuthError] = useState<string | null>(initialError || null);
  const [providers, setProviders] = useState<Record<string, Provider> | null>(null);

  useEffect(() => {
    const serverError = searchParams?.get("error");
    if (serverError) {
      const errorMessages: { [key: string]: string } = {
        CredentialsSignin: "Invalid email or password. Please try again.",
        OAuthSignin: "Error signing in with OAuth provider.",
        // Add more specific error messages as needed
      };
      setAuthError(errorMessages[serverError] || "An unknown authentication error occurred.");
    }
  }, [searchParams]);

  useEffect(() => {
    async function fetchProviders() {
      const res = await getProviders();
      setProviders(res);
    }
    fetchProviders().catch(console.error);
  }, []);

  const handleCredentialsSignIn = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);
    setAuthError(null);
    try {
      const result = await signIn("credentials", {
        redirect: false, // Handle redirect manually for better UX
        email,
        password,
        callbackUrl: callbackUrl || "/",
      });
      if (result?.error) {
        setAuthError(result.error === "CredentialsSignin" ? "Invalid email or password." : result.error);
        toast.error(result.error === "CredentialsSignin" ? "Invalid email or password." : result.error);
      } else if (result?.ok && result.url) {
        toast.success("Signed in successfully!");
        router.push(result.url); // Navigate to callbackUrl or dashboard
      } else {
        // Should not happen if no error and no url
        setAuthError("Sign in failed. Please try again.");
      }
    } catch (err) {
      setAuthError("An unexpected error occurred during sign in.");
      toast.error("An unexpected error occurred.");
    } finally {
      setIsLoading(false);
    }
  };

  const handleOAuthSignIn = (providerId: string) => {
    setIsLoading(true); // Set loading for OAuth as well
    signIn(providerId, { callbackUrl: callbackUrl || "/" }).catch(err => {
        setIsLoading(false);
        toast.error(`Failed to sign in with ${providerId}.`);
        console.error("OAuth sign in error", err);
    });
  };

  return (
    <div className="rounded-lg border border-border bg-card p-6 shadow-sm sm:p-8">
      {authError && (
        <div className="mb-4 rounded-md border border-destructive/50 bg-destructive/10 p-3 text-center text-sm text-destructive">
          {authError}
        </div>
      )}
      <form onSubmit={handleCredentialsSignIn} className="space-y-6">
        <div>
          <Label htmlFor="email">Email address</Label>
          <Input id="email" name="email" type="email" autoComplete="email" required value={email} onChange={(e) => setEmail(e.target.value)} disabled={isLoading} leftIcon={<FaEnvelope className="h-4 w-4" />} />
        </div>
        <div>
          <Label htmlFor="password">Password</Label>
          <Input id="password" name="password" type="password" autoComplete="current-password" required value={password} onChange={(e) => setPassword(e.target.value)} disabled={isLoading} leftIcon={<FaLock className="h-4 w-4"/>} />
        </div>
        <div className="flex items-center justify-between">
          {/* <div className="flex items-center">
            <input id="remember-me" name="remember-me" type="checkbox" className="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary" />
            <label htmlFor="remember-me" className="ml-2 block text-sm text-gray-900 dark:text-gray-100">Remember me</label>
          </div> */}
          <div className="text-sm">
            <a href="/auth/forgot-password" className="font-medium text-primary hover:text-primary/80">
              Forgot your password?
            </a>
          </div>
        </div>
        <Button type="submit" className="w-full" isLoading={isLoading} loadingText="Signing in...">
          Sign in
        </Button>
      </form>

      {providers && Object.values(providers).some(p => p.type === "oauth") && (
         <>
            <div className="my-6">
                <div className="relative">
                <div className="absolute inset-0 flex items-center" aria-hidden="true">
                    <div className="w-full border-t border-border" />
                </div>
                <div className="relative flex justify-center text-sm">
                    <span className="bg-card px-2 text-muted-foreground">Or continue with</span>
                </div>
                </div>
            </div>
            <div className="space-y-3">
                {Object.values(providers).map((provider) => {
                if (provider.type === "oauth" && provider.id === "google") { // Only show Google for this example
                    return (
                    <Button key={provider.name} variant="outline" className="w-full" onClick={() => handleOAuthSignIn(provider.id)} disabled={isLoading}>
                        <FaGoogle className="mr-2 h-4 w-4" /> Sign in with {provider.name}
                    </Button>
                    );
                }
                return null;
                })}
            </div>
         </>
      )}
    </div>
  );
}
```

# src/app/page.tsx
```tsx
// src/app/page.tsx
import Link from "next/link";
import Image from "next/image";
import { type Metadata } from "next";

import { createServerActionClient } from "~/trpc/server"; // Correct import
import { env } from "~/env.js";

import HomePageClientInteractions from "./HomePageClientInteractions";
import { Button } from "~/components/ui/Button"; 
import { ProductGrid } from "~/components/products/ProductGrid"; 

export async function generateMetadata(): Promise<Metadata> {
  const siteName = "The Scent"; 
  const defaultTitle = `${siteName} | Signature Aromatherapy & Wellness`;
  const defaultDescription = "Discover handcrafted aromatherapy products for wellness and self-care. Experience the transformative power of nature with The Scent.";
  const siteUrl = env.NEXT_PUBLIC_SITE_URL || "http://localhost:3000";

  return {
    title: defaultTitle,
    description: defaultDescription,
    keywords: ["aromatherapy", "wellness", "essential oils", "self-care", "natural products", "mindfulness", "the scent"],
    metadataBase: new URL(siteUrl),
    openGraph: {
      type: "website",
      locale: "en_US",
      url: siteUrl,
      siteName: siteName,
      title: defaultTitle,
      description: defaultDescription,
      images: [ { url: "/images/og-default.jpg", width: 1200, height: 630, alt: `${siteName} Collection` } ],
    },
    twitter: {
      card: "summary_large_image",
      title: defaultTitle,
      description: defaultDescription,
      images: ["/images/twitter-default.jpg"],
    },
  };
}

export default async function HomePage() {
  const serverApi = await createServerActionClient(); // Get request-scoped API client

  let featuredProductsData;
  try {
    // CORRECTED: Removed .query() when using a direct caller
    featuredProductsData = await serverApi.products.getAll({ 
      featured: true,
      limit: 4,
      sortBy: "createdAt_desc",
    });
  } catch (error) {
    console.error("Error fetching featured products for HomePage:", error);
    if (error instanceof Error && 'shape' in error) { 
        console.error("TRPC Error Shape:", (error as any).shape);
    }
    featuredProductsData = { items: [], nextCursor: undefined };
  }
  
  const featuredProducts = featuredProductsData.items;

  return (
    <>
      <HomePageClientInteractions featuredProducts={featuredProducts}>
        <div className="container relative z-10 mx-auto flex h-full items-center px-4">
          <div className="max-w-2xl">
            <h1 className="mb-4 text-4xl font-bold text-white drop-shadow-lg md:text-5xl lg:text-6xl">
              Discover Your Perfect Scent
            </h1>
            <p className="mb-8 text-lg text-white drop-shadow-md md:text-xl">
              Handcrafted aromatherapy products for wellness and self-care.
              Experience the transformative power of nature.
            </p>
            <div className="flex flex-col space-y-4 sm:flex-row sm:space-y-0 sm:space-x-4">
              <Button asChild size="lg" className="shadow-lg">
                <Link href="/products">Shop Collection</Link>
              </Button>
              <Button asChild variant="secondary" size="lg" className="shadow-lg">
                <Link href="/quiz">Take Scent Quiz</Link>
              </Button>
            </div>
          </div>
        </div>
      </HomePageClientInteractions>
      
      <section id="about" className="py-16 md:py-24 bg-background">
        <div className="container mx-auto px-4">
          <div className="grid grid-cols-1 items-center gap-8 md:grid-cols-2 md:gap-12 lg:gap-16">
            <div className="order-2 md:order-1">
              <span className="mb-2 block text-sm font-semibold uppercase tracking-wide text-primary">Our Philosophy</span>
              <h2 className="mb-6 text-3xl font-bold tracking-tight text-foreground sm:text-4xl">
                Crafted with Nature, For Your Well-being
              </h2>
              <p className="mb-4 text-muted-foreground">
                The Scent was born from a deep passion for aromatherapy and
                natural wellness. Our founder, after years of exploring holistic practices, 
                discovered the transformative power of pure essential oils.
              </p>
              <p className="mb-6 text-muted-foreground">
                We believe in the power of scent to transform mood, enhance
                well-being, and create moments of tranquility in our busy lives. Each product
                is thoughtfully formulated with the finest natural ingredients.
              </p>
              <Button asChild variant="outline">
                <Link href="/about">Learn More About Us</Link>
              </Button>
            </div>
            
            <div className="relative order-1 h-[400px] md:order-2 md:h-[500px]">
              <div className="absolute left-0 top-0 h-64 w-48 transform overflow-hidden rounded-lg shadow-xl md:h-72 md:w-56 lg:h-80 lg:w-64">
                <Image
                  src="/images/about-1.jpg" 
                  alt="Handcrafting aromatherapy products"
                  fill
                  sizes="(max-width: 768px) 50vw, 33vw"
                  className="object-cover"
                  priority
                />
              </div>
              <div className="absolute bottom-0 right-0 h-56 w-44 transform overflow-hidden rounded-lg shadow-xl md:bottom-4 md:right-4 md:h-64 md:w-52 lg:h-72 lg:w-60">
                <Image
                  src="/images/about-2.jpg"
                  alt="Natural ingredients like lavender and herbs"
                  fill
                  sizes="(max-width: 768px) 50vw, 33vw"
                  className="object-cover"
                />
              </div>
            </div>
          </div>
        </div>
      </section>
      
      <section className="bg-muted/30 py-16 md:py-24">
        <div className="container mx-auto px-4">
          <div className="mb-12 text-center">
            <h2 className="text-3xl font-bold tracking-tight text-foreground sm:text-4xl">
              Featured Products
            </h2>
            <p className="mt-4 max-w-2xl mx-auto text-lg text-muted-foreground">
              Discover our most loved aromatherapy creations, perfect for enhancing your daily rituals.
            </p>
          </div>
          
          {featuredProducts && featuredProducts.length > 0 ? (
            <ProductGrid products={featuredProducts} />
          ) : (
            <p className="text-center text-muted-foreground">
              Our featured products are currently being curated. Check back soon!
            </p>
          )}
          
          <div className="mt-12 text-center">
            <Button asChild size="lg">
                <Link href="/products">View All Products</Link>
            </Button>
          </div>
        </div>
      </section>
    </>
  );
}
```

